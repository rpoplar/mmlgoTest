<?xml version="1.0" encoding="utf-8"?>
<SQLConfig xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <SQLList>
    <SQL SQLKey="DeleteProjectStatReport" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[
                 DELETE FROM Report.ProjectStatReport WHERE sysno = @SysNo;
		          ]]>
      </Text>
    </SQL>

    <SQL SQLKey="DeleteProjectStatReportByProject" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[
                 DELETE FROM Report.ProjectStatReport WHERE ProjectSysNo = @ProjectSysNo;
		          ]]>
      </Text>
    </SQL>
    <SQL SQLKey="DeleteProjectStatReportHistory" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[
                 DELETE FROM Report.ProjectStatReport WHERE Date <= @CutDate;
		          ]]>
      </Text>
    </SQL>


    <!-- 创建ProjectStatReport信息 -->
    <SQL SQLKey="InsertProjectStatReport" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[
                INSERT INTO Report.ProjectStatReport
                (
                   `ProjectSysNo`,
               `ProjectCode`,
               `ProjectName`,
               `ProjectStatus`,
               `ContractorSysNo`,
               `ContractorCode`,
               `ContractorName`,
               `SubContractorSysNo`,
               `SubContractorName`,
               `SubContractorPinyin`,
               `TeamSysNo`,
               `TeamName`,
               `TeamLeader`,
               `Date`,
               `AllWorkerNum`,
               `IssueCardWorkerNum`,
               `EntryWorkerNum`,
               `ExitWorkerNum`,
               `RealWorkingWorkerNum`,
               `InWorkerNum`,
               `AttendanceWorkerNum`
                ) 
                VALUES 
                (
                    @ProjectSysNo,
                @ProjectCode,
                @ProjectName,
                @ProjectStatus,
                @ContractorSysNo,
                @ContractorCode,
                @ContractorName,
                @SubContractorSysNo,
                @SubContractorName,
                @SubContractorPinyin,
                @TeamSysNo,
                @TeamName,
                @TeamLeader,
                @Date,
                @AllWorkerNum,
                @IssueCardWorkerNum,
                @EntryWorkerNum,
                @ExitWorkerNum,
                @RealWorkingWorkerNum,
                @InWorkerNum,
                @AttendanceWorkerNum
                );
          ]]>
      </Text>
    </SQL>

    <!-- 更新ProjectStatReport信息 -->
    <SQL SQLKey="UpdateProjectStatReport" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[
            UPDATE Report.ProjectStatReport SET 
                    `ProjectSysNo` = @ProjectSysNo,
                `ProjectCode` = @ProjectCode,
                `ProjectName` = @ProjectName,
                `ProjectStatus` = @ProjectStatus,
                `ContractorSysNo` = @ContractorSysNo,
                `ContractorCode` = @ContractorCode,
                `ContractorName` = @ContractorName,
                `SubContractorSysNo` = @SubContractorSysNo,
                `SubContractorName` = @SubContractorName,
                `SubContractorPinyin` = @SubContractorPinyin,
                `TeamSysNo` = @TeamSysNo,
                `TeamName` = @TeamName,
                `TeamLeader` = @TeamLeader,
                `Date` = @Date,
                `AllWorkerNum` = @AllWorkerNum,
                `IssueCardWorkerNum` = @IssueCardWorkerNum,
                `EntryWorkerNum` = @EntryWorkerNum,
                `ExitWorkerNum` = @ExitWorkerNum,
                `RealWorkingWorkerNum` = @RealWorkingWorkerNum,
                `InWorkerNum` = @InWorkerNum,
                `AttendanceWorkerNum` = @AttendanceWorkerNum,
                `EditDate` = now()
 
            WHERE sysno = @SysNo;
          ]]>
      </Text>
    </SQL>

    <!-- 加载ProjectStatReport信息 -->
    <SQL SQLKey="LoadProjectStatReport" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
                SELECT 
                * 
                FROM Report.ProjectStatReport 
                WHERE sysno = @SysNo;
          ]]>
      </Text>
    </SQL>


    <!-- 分页查询ProjectStatReport信息 -->
    <SQL SQLKey="QueryProjectStatReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
    SELECT COUNT(1) AS TotalCount
      FROM Report.ProjectStatReport
      #STRWHERE#;        
      SELECT 
        
                 `SysNo`
                ,`ProjectSysNo`
                ,`ProjectCode`
                ,`ProjectName`
                ,`ProjectStatus`
                ,`ContractorSysNo`
                ,`ContractorCode`
                ,`ContractorName`
                ,`SubContractorSysNo`
                ,`SubContractorName`
                ,`SubContractorPinyin`
                ,`TeamSysNo`
                ,`TeamName`
                ,`TeamLeader`
                ,`Date`
                ,`AllWorkerNum`
                ,`IssueCardWorkerNum`
                ,`EntryWorkerNum`
                ,`ExitWorkerNum`
                ,`RealWorkingWorkerNum`
                ,`InWorkerNum`
                ,`AttendanceWorkerNum`
                ,`SystemSenceWorkerNum`
                ,`ManualSenceWorkerNum`
                ,`EditDate`
	
      FROM Report.ProjectStatReport
        #STRWHERE# ORDER BY @SortFields  LIMIT @StartNum, @PageSize;
            ]]>
      </Text>
    </SQL>


    <!-- 加载ProjectStatReport信息 -->
    <SQL SQLKey="GetProjectStatReportTotalNumCount" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
        select 
sum(AllWorkerNum) as AllWorkerNumSum
,sum(IssueCardWorkerNum) as IssueCardWorkerNumSum
,sum(EntryWorkerNum) as EntryWorkerNumSum
,sum(ExitWorkerNum) as ExitWorkerNumSum
,sum(RealWorkingWorkerNum)  as RealWorkingWorkerNumSum
from report.projectstatreport #STRWHERE#;
          ]]>
      </Text>
    </SQL>


    <SQL SQLKey="AnalysisProjectStat" ConnectionKey="LaborMainRead">
      <Text>
        <![CDATA[
SELECT 
	ProjectSysNo,
	SubContractorSysNo,
	SysNo AS TeamSysNo,
	TeamName,
	TeamLeader
  
FROM ProjectMgt.TeamMaster
#STRWHERE#
ORDER BY ProjectSysNo, TeamSysNo
          ]]>
      </Text>
    </SQL>




    <SQL SQLKey="AnalysisProjectStatDetail" ConnectionKey="LaborProjectRead">
      <Text>
        <![CDATA[
SELECT 
	(SELECT COUNT(1) FROM ProjectData.ProjectWorker 
		WHERE ProjectData.ProjectWorker.ProjectSysNo = @ProjectSysNo 
				AND ProjectData.ProjectWorker.TeamSysNo = @TeamMasterSysNo 
				AND Status <> -999) AS AllWorkerNum, 				#花名册人数

	(SELECT COUNT(1) FROM ProjectData.ProjectWorker 
		WHERE ProjectData.ProjectWorker.ProjectSysNo = @ProjectSysNo 
				AND ProjectData.ProjectWorker.TeamSysNo = @TeamMasterSysNo 
				AND IssueCardTime IS NOT NULL 
				AND CompleteCardTime IS NULL 
				AND Status <> -999) AS IssueCardWorkerNum, 	#持卡工人数

	(SELECT COUNT(1) FROM ProjectData.ProjectWorker 
		WHERE ProjectData.ProjectWorker.ProjectSysNo = @ProjectSysNo 
				AND ProjectData.ProjectWorker.TeamSysNo = @TeamMasterSysNo
				AND EntryTime IS NOT NULL 
				AND Status <> -999) AS EntryWorkerNum, 			#总进场人数

	(SELECT COUNT(1) FROM ProjectData.ProjectWorker 
		WHERE ProjectData.ProjectWorker.ProjectSysNo = @ProjectSysNo  
				AND ProjectData.ProjectWorker.TeamSysNo = @TeamMasterSysNo 
				AND ExitTime IS NOT NULL 
				AND Status <> -999) AS ExitWorkerNum, 			#总退场人数

	(SELECT COUNT(1) FROM ProjectData.ProjectWorker 
		WHERE ProjectData.ProjectWorker.ProjectSysNo = @ProjectSysNo  
				AND ProjectData.ProjectWorker.TeamSysNo = @TeamMasterSysNo
				AND CurrentDayStatus = 1 
        AND EXISTS (SELECT 1 FROM ProjectData.WorkerAttendance 
											WHERE ProjectData.WorkerAttendance.ProjectSysNo = @ProjectSysNo  
													AND ProjectData.WorkerAttendance.TeamSysNo = @TeamMasterSysNo 
													AND ProjectData.WorkerAttendance.WorkerSysNo = ProjectData.ProjectWorker.WorkerSysNo 
													AND ProjectData.WorkerAttendance.Date >= REPLACE(CURRENT_DATE()-1, '-', ''))
				AND Status <> -999) AS RealWorkingWorkerNum, 	#实时现场人数

	(SELECT COUNT(1) FROM ProjectData.ProjectWorker 
		WHERE ProjectData.ProjectWorker.ProjectSysNo = @ProjectSysNo 
				AND ProjectData.ProjectWorker.TeamSysNo = @TeamMasterSysNo 
				AND EntryTime IS NOT NULL  
				AND ExitTime IS NULL 
				AND Status <> -999) AS InWorkerNum, 				#在场人数

	(SELECT COUNT(1) FROM ProjectData.ProjectWorker
		WHERE ProjectData.ProjectWorker.ProjectSysNo = @ProjectSysNo  
				AND ProjectData.ProjectWorker.TeamSysNo = @TeamMasterSysNo 
				AND Status <> -999
				AND ((ProjectData.ProjectWorker.CurrentDayStatus = 1 AND EXISTS (SELECT 1 FROM ProjectData.WorkerAttendance 
											WHERE ProjectData.WorkerAttendance.ProjectSysNo = @ProjectSysNo  
													AND ProjectData.WorkerAttendance.TeamSysNo = @TeamMasterSysNo 
													AND ProjectData.WorkerAttendance.WorkerSysNo = ProjectData.ProjectWorker.WorkerSysNo 
													AND ProjectData.WorkerAttendance.Date >= REPLACE(CURRENT_DATE()-1, '-', '')))
						OR EXISTS (SELECT 1 FROM ProjectData.WorkerAttendance 
											WHERE ProjectData.WorkerAttendance.ProjectSysNo = @ProjectSysNo  
													AND ProjectData.WorkerAttendance.TeamSysNo = @TeamMasterSysNo 
													AND ProjectData.WorkerAttendance.WorkerSysNo = ProjectData.ProjectWorker.WorkerSysNo 
													AND ProjectData.WorkerAttendance.Date = REPLACE(CURRENT_DATE(), '-', '')))
	) AS AttendanceWorkerNum 	#出勤人数（有打卡记录的）

          ]]>
      </Text>
    </SQL>

    <SQL SQLKey="CreateOrUpdateProjectStatReportList" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[
INSERT INTO `report`.`projectstatreport` (
	`ProjectSysNo`,
	`ProjectCode`,
	`ProjectName`,
	`ProjectStatus`,
	`ContractorSysNo`,
	`ContractorCode`,
	`ContractorName`,
	`SubContractorSysNo`,
	`SubContractorName`,
	`SubContractorPinyin`,
	`TeamSysNo`,
	`TeamName`,
	`TeamLeader`,
	`Date`,
	`AllWorkerNum`,
	`IssueCardWorkerNum`,
	`EntryWorkerNum`,
	`ExitWorkerNum`,
	`RealWorkingWorkerNum`,
	`InWorkerNum`,
	`AttendanceWorkerNum`,
  `SystemAttendenceWorkerNum`,
  `ManualAttendenceWorkerNum`,
  `SystemSenceWorkerNum`,
  `ManualSenceWorkerNum`,
	`EditDate`
) SELECT
	#ProjectSysNo# AS ProjectSysNo,
	#ProjectCode# AS ProjectCode,
	#ProjectName# AS ProjectName,
	#ProjectStatus# AS ProjectStatus,
	#ContractorSysNo# AS ContractorSysNo,
	#ContractorCode# AS ContractorCode,
	#ContractorName# AS ContractorName,
	#SubContractorSysNo# AS SubContractorSysNo,
	#SubContractorName# AS SubContractorName,
	#SubContractorPinyin# AS SubContractorPinyin,
	#TeamSysNo# AS TeamSysNo,
	#TeamName# AS TeamName,
	#TeamLeader# AS TeamLeader,
	#Date# AS Date,
	#AllWorkerNum# AS AllWorkerNum,
	#IssueCardWorkerNum# AS IssueCardWorkerNum,
	#EntryWorkerNum# AS EntryWorkerNum,
	#ExitWorkerNum# AS ExitWorkerNum,
	#RealWorkingWorkerNum# AS RealWorkingWorkerNum,
	#InWorkerNum# AS InWorkerNum,
	#AttendanceWorkerNum# AS AttendanceWorkerNum,
	#SystemAttendenceWorkerNum# AS SystemAttendenceWorkerNum,
	#ManualAttendenceWorkerNum# AS ManualAttendenceWorkerNum,
  #SystemSenceWorkerNum# AS SystemSenceWorkerNum,
  #ManualSenceWorkerNum# AS ManualSenceWorkerNum,
	now() AS EditDate
ON DUPLICATE KEY UPDATE 
 `ProjectSysNo` = #ProjectSysNo#,
 `ProjectCode` = #ProjectCode#,
 `ProjectName` = #ProjectName#,
 `ProjectStatus` = #ProjectStatus#,
 `ContractorSysNo` = #ContractorSysNo#,
 `ContractorCode` = #ContractorCode#,
 `ContractorName` = #ContractorName#,
 `SubContractorSysNo` = #SubContractorSysNo#,
 `SubContractorName` = #SubContractorName#,
 `SubContractorPinyin` = #SubContractorPinyin#,
 `TeamSysNo` = #TeamSysNo#,
 `TeamName` = #TeamName#,
 `TeamLeader` = #TeamLeader#,
 `Date` = #Date#,
 `AllWorkerNum` = #AllWorkerNum#,
 `IssueCardWorkerNum` = #IssueCardWorkerNum#,
 `EntryWorkerNum` = #EntryWorkerNum#,
 `ExitWorkerNum` = #ExitWorkerNum#,
 `RealWorkingWorkerNum` = #RealWorkingWorkerNum#,
 `InWorkerNum` = #InWorkerNum#,
 `AttendanceWorkerNum` = #AttendanceWorkerNum#,
 `SystemAttendenceWorkerNum` = #SystemAttendenceWorkerNum#,
 `ManualAttendenceWorkerNum` = #ManualAttendenceWorkerNum#,
 `SystemSenceWorkerNum` = #SystemSenceWorkerNum#,
 `ManualSenceWorkerNum` = #ManualSenceWorkerNum#,
 `EditDate` = now();
          ]]>
      </Text>
    </SQL>

    <!--项目工人考勤统计-->
    <!-- 创建ProjectWorkerExAttendance信息 -->
    <SQL SQLKey="SaveProjectWorkerExAttendance" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[
                INSERT INTO Report.ProjectWorkerExAttendance
                (
                   `ProjectSysNo`,
                   `ContractorSysNo`,
                   `SubContractorSysNo`,
                   `SubContractorName`,
                   `TeamSysNo`,
                   `TeamName`,
                   `IDCardNumber`,
                   `WorkerSysNo`,
                   `WorkerName`,
                   `WorkTypeSysNo`,
                   `WorkTypeName`,
                   `AttendanceType`,
                   `Day`,
                   `EntryTime`,
                   `ExitTime`,
                   `EditDate`
                ) 
                VALUES 
                (
                    #ProjectSysNo#,
                    #ContractorSysNo#,
                    #SubContractorSysNo#,
                    '#SubContractorName#',
                    #TeamSysNo#,
                    '#TeamName#',
                    '#IDCardNumber#',
                    #WorkerSysNo#,
                    '#WorkerName#',
                    #WorkTypeSysNo#,
                    '#WorkTypeName#',
                    '#AttendanceType#',
                    '#Day#',
                    '#EntryTime#',
                    '#ExitTime#',
                    now()
                ) ON DUPLICATE KEY UPDATE AttendanceType = #AttendanceType#,
	                EntryTime = '#EntryTime#',
	                ExitTime = '#ExitTime#',
	                EditDate = now();
          ]]>
      </Text>
    </SQL>
    <!-- 创建ProjectWorkerExAttendance信息 -->
    <SQL SQLKey="GetProjectWorkerExAttendanceList" ConnectionKey="LaborProjectRead">
      <Text>
        <![CDATA[
            SELECT
                    A.SysNo,
	                A.`ProjectSysNo`
                  ,B.`ContractorSysNo`
                  ,B.`SubContractorSysNo`
                  ,B.`SubContractorName`
                  ,A.`TeamSysNo`
                  ,B.`TeamName`
                  ,A.`WorkerSysNo`
                  ,A.`WorkerName`
                  ,A.`IDCardType`
                  ,A.`IDCardNumber`
                  ,A.`WorkTypeSysNo`
                  ,B.`WorkTypeName`
                  ,A.`Date`
                  ,A.`Records` AS `RecordsRaw`
                  ,A.`WorkHours`
                  ,A.`InDate`
                  ,A.`SplitCode`
                  ,A.`AvailableDays`
            FROM
            projectdata.workerattendance  A
            inner join projectdata.projectworker B 
            on A.ProjectSysNo=B.ProjectSysNo
            and A.WorkerSysNo=B.WorkerSysNo
            and A.SubContractorSysNo=B.SubContractorSysNo 
            #STRWHERE# 
          ]]>
      </Text>
    </SQL>

    <!-- 获取项目所有已经进场的工人的考勤信息 -->
    <SQL SQLKey="GetProjectAllEntryWorkerAttendanceList" ConnectionKey="LaborProjectRead">
      <Text>
        <![CDATA[
 SELECT
	B.`ProjectSysNo`,
	B.`ContractorSysNo`,
	B.`SubContractorSysNo`,
	B.`SubContractorName`,
	B.`TeamSysNo`,
	B.`TeamName`,
	B.`WorkerSysNo`,
	B.`WorkerName`,
	B.`IDCardType`,
	B.`IDCardNumber`,
	B.`WorkTypeSysNo`,
	B.`WorkTypeName`,
  B.`EntryTime`,
  B.`ExitTime`,
  B.`FinalAttendance`,
  B.`CardStatus`,
  B.`CardNumber`,
	A.`Date`,
	A.`Records` AS `RecordsRaw`,
	A.`WorkHours`,
	A.`InDate`,
	A.`SplitCode`,
	A.`AvailableDays`,
  B.`FinalEntryTime`,
  B.`FinalExitTime`
FROM
	projectdata.projectworker B
LEFT JOIN projectdata.workerattendance A ON A.ProjectSysNo = B.ProjectSysNo and A.Date = @Date
AND A.WorkerSysNo = B.WorkerSysNo
AND A.SubContractorSysNo = B.SubContractorSysNo
            #STRWHERE# AND B.entrytime IS NOT NULL
AND B.entrytime <= @EntryDate
AND (
	B.exittime IS NULL
	OR  @ExitDate <= B.exittime
)
order by SubContractorSysNo,TeamSysNo,WorkerSysNo
          ]]>
      </Text>
    </SQL>
    <!-- 分页获取项目所有已经进场的工人的考勤信息 -->
    <SQL SQLKey="QueryProjectAllEntryWorkerAttendanceList" ConnectionKey="Read">
      <Text>
        <![CDATA[
               SELECT
                 COUNT(1) AS TotalCount
              FROM
	              projectdata.projectworker B
              LEFT JOIN projectdata.workerattendance A ON A.ProjectSysNo = B.ProjectSysNo and A.Date = @Date
              AND A.WorkerSysNo = B.WorkerSysNo
              AND A.SubContractorSysNo = B.SubContractorSysNo
              #STRWHERE# AND B.entrytime IS NOT NULL
              AND B.entrytime <= @EntryDate
              AND (
	              B.exittime IS NULL
	              OR  @ExitDate <= B.exittime
              )
              order by SubContractorSysNo,TeamSysNo,WorkerSysNo;        
             SELECT
	            B.`ProjectSysNo`,
	            B.`ContractorSysNo`,
	            B.`SubContractorSysNo`,
	            B.`SubContractorName`,
	            B.`TeamSysNo`,
	            B.`TeamName`,
	            B.`WorkerSysNo`,
	            B.`WorkerName`,
	            B.`IDCardType`,
	            B.`IDCardNumber`,
	            B.`WorkTypeSysNo`,
	            B.`WorkTypeName`,
              B.`EntryTime`,
              B.`FinalAttendance`,
              B.`CardStatus`,
              B.`CardNumber`,
	            A.`Date`,
	            A.`Records` AS `RecordsRaw`,
	            A.`WorkHours`,
	            A.`InDate`,
	            A.`SplitCode`,
	            A.`AvailableDays`，
              B.FinalEntryTime,
              B.FinalExitTime
            FROM
	             projectdata.projectworker B
            LEFT JOIN projectdata.workerattendance A ON A.ProjectSysNo = B.ProjectSysNo and A.Date = @Date
            AND A.WorkerSysNo = B.WorkerSysNo
            AND A.SubContractorSysNo = B.SubContractorSysNo
            #STRWHERE# AND B.entrytime IS NOT NULL
            AND B.entrytime <= @EntryDate
            AND (
	            B.exittime IS NULL
	            OR  @ExitDate <= B.exittime
            )
            order by SubContractorSysNo,TeamSysNo,WorkerSysNo  LIMIT @StartNum, @PageSize;
         ]]>
      </Text>
    </SQL>

    <!-- 分页查询ProjectWorkerExAttendance信息 -->
    <SQL SQLKey="QueryProjectWorkerExAttendanceList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
    SELECT COUNT(1) AS TotalCount
      FROM Report.ProjectWorkerExAttendance
      #STRWHERE#;        
    SET  @row_number = 0;
    SELECT 
        rn
	             `SysNo`
                ,`ProjectSysNo`
                ,`ContractorSysNo`
                ,`SubContractorSysNo`
                ,`SubContractorName`
                ,`TeamSysNo`
                ,`TeamName`
                ,`IDCardNumber`
                ,`WorkerSysNo`
                ,`WorkerName`
                ,`WorkTypeSysNo`
                ,`WorkTypeName`
                ,`AttendanceType`
                ,`Day`
                ,`EntryTime`
                ,`ExitTime`
                ,`EditDate`

    FROM
    (
    SELECT (@row_number:=@row_number + 1) AS rn,R.* FROM (
           SELECT 
	             `SysNo`
                ,`ProjectSysNo`
                ,`ContractorSysNo`
                ,`SubContractorSysNo`
                ,`SubContractorName`
                ,`TeamSysNo`
                ,`TeamName`
                ,`IDCardNumber`
                ,`WorkerSysNo`
                ,`WorkerName`
                ,`WorkTypeSysNo`
                ,`WorkTypeName`
                ,`AttendanceType`
                ,`Day`
                ,`EntryTime`
                ,`ExitTime`
                ,`EditDate`
               FROM Report.ProjectWorkerExAttendance
               #STRWHERE# ORDER BY @SortFields  
        ) R
      ) T WHERE T.rn > (@PageIndex * @PageSize) LIMIT @PageSize;
            ]]>
      </Text>
    </SQL>


    <!--项目工人考勤统计End-->

    <!--企业项目统计报表Start-->
    <!-- 分页查询R_ContractorProject_Report信息 -->
    <SQL SQLKey="QueryContractorProjectReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
            SELECT COUNT(1) AS TotalCount
              FROM Report.R_ContractorProject_Report
              #STRWHERE#;        
            SET  @row_number = 0;
            SELECT 
                       rn
	                      ,`SysNo`
                        ,`ContractorSysNo`
                        ,`ContractorCode`
                        ,`ContractorName`
                        ,`StatType`
                        ,`StatRange`
                        ,`StatRangeType`
                        ,`StatRangeStartDate`
                        ,`StatRangeEndDate`
                        ,`OnBulidProjectNum`
                        ,`NewBulidProjectNum`
                        ,`RegisteredWorkerNum`
                        ,`EntryWorkerNum`
                        ,`JoinSubContractorNum`
                        ,`EntrySubContractorNum`
                        ,`RangeWorkHoursNum`
                        ,`RangeManualWorkHoursNum`
                        ,`RangeTotalActualAmount`
                        ,`EditUserName`
                        ,`EditDate`

            FROM
            (
            SELECT (@row_number:=@row_number + 1) AS rn,R.* FROM (
              SELECT 
                        `SysNo`
                        ,`ContractorSysNo`
                        ,`ContractorCode`
                        ,`ContractorName`
                        ,`StatType`
                        ,`StatRange`
                        ,`StatRangeType`
                        ,`StatRangeStartDate`
                        ,`StatRangeEndDate`
                        ,`OnBulidProjectNum`
                        ,`NewBulidProjectNum`
                        ,`RegisteredWorkerNum`
                        ,`EntryWorkerNum`
                        ,`JoinSubContractorNum`
                        ,`EntrySubContractorNum`
                        ,`RangeWorkHoursNum`
                        ,`RangeManualWorkHoursNum`
                        ,`RangeTotalActualAmount`
                        ,`EditUserName`
                        ,`EditDate`
	
              FROM Report.R_ContractorProject_Report
                #STRWHERE# ORDER BY @SortFields  
                ) R
              ) T WHERE T.rn > (@PageIndex * @PageSize) LIMIT @PageSize;
            ]]>
      </Text>
    </SQL>

    <!--企业项目统计报表End-->

    <!-- 分包商排行统计报表Start-->
    <!-- 分页查询R_SubContractorRank_Report信息 -->
    <SQL SQLKey="QuerySubContractorRankReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
              SELECT COUNT(1) AS TotalCount
                FROM Report.R_SubContractorRank_Report
                #STRWHERE#;        
              SET  @row_number = 0;
              SELECT 
                  rn
	                        ,`SysNo`
                          ,`ContractorSysNo`
                          ,`ContractorCode`
                          ,`ContractorName`
                          ,`SubContractorSysNo`
                          ,`SubContractorName`
                          ,`SubContractorTypeSysNo`
                          ,`SubContractorTypeName`
                          ,`StatType`
                          ,`StatRange`
                          ,`StatRangeType`
                          ,`StatRangeStartDate`
                          ,`StatRangeEndDate`
                          ,`RegisteredProjectNum`
                          ,`RegisteredWorkerNum`
                          ,`ContractWorkerNum`
                          ,`InsuranceWorkerNum`
                          ,`JoinProjectNum`
                          ,`JoinProjectWorkerNum`
                          ,`JoinProjectManagerNum`
                          ,`NowProjectNum`
                          ,`NowEntryWorkerNum`
                          ,`NowEntryManagerNum`
                          ,`RangeEntryWorkerNum`
                          ,`RangeEntryManagerNum`
                          ,`RangeWorkHoursNum`
                          ,`RangeManualWorkHoursNum`
                          ,`RangeTotalActualAmount`
                          ,`EditUserName`
                          ,`EditDate`

              FROM
              (
              SELECT (@row_number:=@row_number + 1) AS rn,R.* FROM (
                SELECT 
                                  `SysNo`
                          ,`ContractorSysNo`
                          ,`ContractorCode`
                          ,`ContractorName`
                          ,`SubContractorSysNo`
                          ,`SubContractorName`
                          ,`SubContractorTypeSysNo`
                          ,`SubContractorTypeName`
                          ,`StatType`
                          ,`StatRange`
                          ,`StatRangeType`
                          ,`StatRangeStartDate`
                          ,`StatRangeEndDate`
                          ,`RegisteredProjectNum`
                          ,`RegisteredWorkerNum`
                          ,`ContractWorkerNum`
                          ,`InsuranceWorkerNum`
                          ,`JoinProjectNum`
                          ,`JoinProjectWorkerNum`
                          ,`JoinProjectManagerNum`
                          ,`NowProjectNum`
                          ,`NowEntryWorkerNum`
                          ,`NowEntryManagerNum`
                          ,`RangeEntryWorkerNum`
                          ,`RangeEntryManagerNum`
                          ,`RangeWorkHoursNum`
                          ,`RangeManualWorkHoursNum`
                          ,`RangeTotalActualAmount`
                          ,`EditUserName`
                          ,`EditDate`
	
                FROM Report.R_SubContractorRank_Report
                  #STRWHERE# ORDER BY @SortFields  
                  ) R
                ) T WHERE T.rn > (@PageIndex * @PageSize) LIMIT @PageSize;
            ]]>
      </Text>
    </SQL>
    <!-- 分包商排行统计报表End-->

    <!-- 流动党员统计报表Start-->
    <!-- 分页查询R_FlowPartyMember_Report信息 -->
    <SQL SQLKey="QueryFlowPartyMemberReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
                SELECT COUNT(1) AS TotalCount
                  FROM Report.R_FlowPartyMember_Report
                  #STRWHERE#;        
                SET  @row_number = 0;
                SELECT 
                    rn
	                          ,`SysNo`
                            ,`ContractorSysNo`
                            ,`ContractorCode`
                            ,`ContractorName`
                            ,`StatType`
                            ,`StatRange`
                            ,`StatRangeType`
                            ,`StatRangeStartDate`
                            ,`StatRangeEndDate`
                            ,`TotalProjectNum`
                            ,`OnBulidProjectNum`
                            ,`HasPartyOrganizationProjectNum`
                            ,`HasPartyOrganizationOnBulidNum`
                            ,`EntryFlowPartyMemberNum`
                            ,`RangeAuthPartyNum`
                            ,`RangePartyActivityNum`
                            ,`RangePartyActivityMemberNum`
                            ,`EditUserName`
                            ,`EditDate`

                FROM
                (
                SELECT (@row_number:=@row_number + 1) AS rn,R.* FROM (
                  SELECT 
                             `SysNo`
                            ,`ContractorSysNo`
                            ,`ContractorCode`
                            ,`ContractorName`
                            ,`StatType`
                            ,`StatRange`
                            ,`StatRangeType`
                            ,`StatRangeStartDate`
                            ,`StatRangeEndDate`
                            ,`TotalProjectNum`
                            ,`OnBulidProjectNum`
                            ,`HasPartyOrganizationProjectNum`
                            ,`HasPartyOrganizationOnBulidNum`
                            ,`EntryFlowPartyMemberNum`
                            ,`RangeAuthPartyNum`
                            ,`RangePartyActivityNum`
                            ,`RangePartyActivityMemberNum`
                            ,`EditUserName`
                            ,`EditDate`
	
                  FROM Report.R_FlowPartyMember_Report
                    #STRWHERE# ORDER BY @SortFields  
                    ) R
                  ) T WHERE T.rn > (@PageIndex * @PageSize) LIMIT @PageSize;
            ]]>
      </Text>
    </SQL>
    <!-- 分包商排行统计报表End-->

    <SQL SQLKey="GetR_Contractor_PayRoll_Reports" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          SELECT
            cm.SysNo                                     ContractorSysNo,
            cm.ContractorCode                            ContractorCode,
            cm.ContractorName                            ContractorName,
            SUM(IFNULL(r.CurrentTotalPayAmount, 0))      CurrentTotalPayAmount,
            SUM(IFNULL(r.CurrentActualAmount, 0))        CurrentActualAmount,
            SUM(IFNULL(r.CurrentIsArrearsOfWages, 0))    CurrentIsArrearsOfWages,
            SUM(IFNULL(r.CurrentTotalArrearsOfWages, 0)) CurrentTotalArrearsOfWages,
            SUM(IFNULL(r.IsArrearsOfWages, 0))           IsArrearsOfWages,
            SUM(IFNULL(r.TotalArrearsOfWages, 0))        TotalArrearsOfWages
          FROM projectmgt.contractormaster cm
            LEFT JOIN
            (
              SELECT
                psr.ContractorCode                      ContractorCode,
                SUM(CASE WHEN psr.Month_Key = @EndMonth
                  THEN IFNULL(psr.TotalPayAmount, 0)
                    ELSE 0 END)                         CurrentTotalPayAmount,
                SUM(CASE WHEN psr.Month_Key = @EndMonth
                  THEN IFNULL(psr.ActualAmount, 0)
                    ELSE 0 END)                         CurrentActualAmount,
                COUNT(DISTINCT (CASE WHEN psr.Month_Key = @EndMonth AND psr.IsArrearsOfWages = 1
                  THEN psr.ProjectSysNo
                                ELSE NULL END))         CurrentIsArrearsOfWages,
                SUM(CASE WHEN psr.Month_Key = @EndMonth
                  THEN IFNULL(psr.TotalArrearsOfWages, 0)
                    ELSE 0 END)                         CurrentTotalArrearsOfWages,
                COUNT(DISTINCT (CASE WHEN psr.IsArrearsOfWages = 1
                  THEN psr.ProjectSysNo
                                ELSE NULL END))         IsArrearsOfWages,
                SUM(IFNULL(psr.TotalArrearsOfWages, 0)) TotalArrearsOfWages
              FROM report.r_contractor_payroll_report psr
                INNER JOIN commonmgt.areacategory_area aca
                  ON LEFT(psr.AreaCode, 2) = LEFT(aca.AreaCode, 2)
                     AND ((LENGTH(@AreaCode) <= 4 AND aca.AreaCategoryCode LIKE CONCAT(@AreaCode, '%'))
                          OR (LENGTH(@AreaCode) = 6 AND LEFT(aca.AreaCode, 2) = LEFT(@AreaCode, 2)))
              WHERE psr.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                    AND psr.Month_Key <= @EndMonth
                    AND (CASE WHEN psr.ProjectSysNo = psr.ParentProjectSysNo
                THEN 0
                         ELSE 1 END) = @ContractorType
              GROUP BY psr.ContractorCode
            ) r
              ON r.ContractorCode LIKE CONCAT(cm.ContractorCode, '%')
          WHERE cm.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                AND LENGTH(cm.ContractorCode) <= LENGTH(@ContractorCode) + 4
                AND cm.Status = 1
          GROUP BY cm.ContractorCode
        ]]>
      </Text>
    </SQL>
    
    <SQL SQLKey="GetR_Contractor_PayRoll_ReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
         select 
		            cm.SysNo ContractorSysNo,
                cm.ContractorCode,
			          cm.ContractorName,
			          IFNULL(da.TotalPayAmount ,0) TotalPayAmount,
			          IFNULL(da.ActualAmount ,0) ActualAmount,
			          IFNULL(da.TotalArrearsOfWages ,0) TotalArrearsOfWages,
                IFNULL(pa.IsArrearsOfWages ,0) IsArrearsOfWages,
			          1  StatContainContractorType
			          from projectmgt.contractormaster cm
			          LEFT JOIN
			          (
                select 
				            left(cm.ContractorCode,@codeLength) ContractorCode,
				          sum(cm.TotalPayAmount)  TotalPayAmount,
				          sum(cm.ActualAmount) ActualAmount,
                  sum(cm.TotalArrearsOfWages) TotalArrearsOfWages
				          from  commonmgt.areacategory_area aca 
				          JOIN report.R_Contractor_PayRoll_Report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)
                   
			          #STRWHERE#   #WHERESTR#



			          GROUP BY  left(cm.ContractorCode,@codeLength)
                
								UNION ALL
                
                
                
                select 
				          left(cm.ContractorCode,@codeNextLength) ContractorCode,
				          sum(cm.TotalPayAmount)  TotalPayAmount,
				          sum(cm.ActualAmount) ActualAmount,
                  sum(cm.TotalArrearsOfWages) TotalArrearsOfWages
				          from  commonmgt.areacategory_area aca 
				          JOIN report.R_Contractor_PayRoll_Report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)

                   
			          #STRWHERE# AND  LENGTH(cm.ContractorCode) >=@codeNextLength #WHERESTR# 



			          GROUP BY  left(cm.ContractorCode,@codeNextLength)
          ) as  da   on da.ContractorCode=cm.ContractorCode
          LEFT JOIN
				  (select 
				          left(cm.ContractorCode,@codeLength) ContractorCode,
				          sum(cm.IsArrearsOfWages) IsArrearsOfWages
				          from  commonmgt.areacategory_area aca 
				          JOIN (
										SELECT cm.parentprojectSysno,cm.ContractorCode,cm.AreaCode,cm.IsArrearsOfWages 
											from report.R_Contractor_PayRoll_Report cm where  cm.ContractorCode LIKE @ContractorCodeLike
											and IsArrearsOfWages = 1 group by ParentProjectSysNo
										) cm on left(cm.AreaCode,2)=left(aca.AreaCode,2) 

                   
			           #STRWHERE#   #WHERESTR#


			          GROUP BY  left(cm.ContractorCode,@codeLength)
                
								UNION ALL 

                select 
				          left(cm.ContractorCode,@codeNextLength) ContractorCode,
				          sum(cm.IsArrearsOfWages) IsArrearsOfWages
				          from  commonmgt.areacategory_area aca 
				          JOIN (
										SELECT cm.parentprojectSysno,cm.ContractorCode,cm.AreaCode,cm.IsArrearsOfWages 
											from report.R_Contractor_PayRoll_Report cm where  cm.ContractorCode LIKE @ContractorCodeLike
											and IsArrearsOfWages = 1 group by ParentProjectSysNo
										) cm on left(cm.AreaCode,2)=left(aca.AreaCode,2) 

                   
			           #STRWHERE# AND  LENGTH(cm.ContractorCode) >=@codeNextLength #WHERESTR# 


			          GROUP BY  left(cm.ContractorCode,@codeNextLength)
						) pa on pa.ContractorCode = cm.ContractorCode
           #STRWHERE# and (LENGTH(cm.ContractorCode)=@codeNextLength or length(cm.ContractorCode)=@codeLength)  and cm.`Status`=1

        
            ]]>
      </Text>
    </SQL>

    <SQL SQLKey="GetR_PartyBuilding_Reports" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          SELECT
            m.SysNo                                   ContractorSysNo,
            m.ContractorCode,
            m.ContractorName,
            SUM(IFNULL(IsPartyOrganization, 0))       IsPartyOrganization,
            SUM(IFNULL(NotPartyOrganization, 0))      NotPartyOrganization,
            SUM(IFNULL(PartyAuthNum, 0))              PartyAuthNum,
            SUM(IFNULL(PartyPendingAuthNum, 0))       PartyPendingAuthNum,
            SUM(IFNULL(LastMonthPartyActivityNum, 0)) LastMonthPartyActivityNum,
            SUM(IFNULL(TotalPartyActivityNum, 0))     TotalPartyActivityNum
          FROM
            projectmgt.contractormaster m
            LEFT JOIN
            (
              SELECT

                cm.ContractorCode,
                SUM(r.IsPartyOrganization)      IsPartyOrganization,
                COUNT(DISTINCT (CASE WHEN r.IsPartyOrganization = 0
                  THEN r.ProjectSysNo
                                ELSE NULL END)) NotPartyOrganization,
                SUM(PartyAuthNum)               PartyAuthNum,
                SUM(PartyPendingAuthNum)        PartyPendingAuthNum,
                SUM(LastMonthPartyActivityNum)  LastMonthPartyActivityNum,
                SUM(TotalPartyActivityNum)      TotalPartyActivityNum
              FROM
                projectmgt.contractormaster cm
                LEFT JOIN report.R_PartyBuilding_Report r
                  ON cm.ContractorCode = r.ContractorCode
                INNER JOIN commonmgt.areacategory_area aca
                  ON LEFT(r.AreaCode, 2) = LEFT(aca.AreaCode, 2)
                     AND ((LENGTH(@AreaCode) <= 4 AND aca.AreaCategoryCode LIKE CONCAT(@AreaCode, '%'))
                          OR (LENGTH(@AreaCode) = 6 AND LEFT(aca.AreaCode, 2) = LEFT(@AreaCode, 2)))
              WHERE r.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                    AND r.ProjectSysNo = r.ParentProjectSysNo
              GROUP BY cm.ContractorCode
            ) t
              ON t.ContractorCode LIKE CONCAT(m.ContractorCode, '%')
          WHERE m.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                AND LENGTH(m.ContractorCode) <= LENGTH(@ContractorCode) + 4
                AND m.Status = 1
          GROUP BY m.ContractorCode;
        ]]>
      </Text>
    </SQL>


    <SQL SQLKey="GetR_PartyBuilding_ReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          select 
		            cm.SysNo ContractorSysNo,
                cm.ContractorCode,
			          cm.ContractorName,
			          IFNULL(pa.IsPartyOrganization ,0) IsPartyOrganization,
                
			          IFNULL(da.PartyAuthNum ,0) PartyAuthNum,
			          IFNULL(da.PartyPendingAuthNum ,0) PartyPendingAuthNum,
			          IFNULL(da.TotalPartyActivityNum ,0) TotalPartyActivityNum,
			          IFNULL(da.LastMonthPartyActivityNum ,0) LastMonthPartyActivityNum,
                IFNULL(na.NotPartyOrganization ,0) NotPartyOrganization,
			          1  StatContainContractorType
			          from projectmgt.contractormaster cm
			          LEFT JOIN
			          (
								select 
				           left(cm.ContractorCode,@codeLength) ContractorCode,
				          sum(cm.PartyAuthNum)  PartyAuthNum,
				          sum(cm.PartyPendingAuthNum) PartyPendingAuthNum,
				          sum(cm.TotalPartyActivityNum)  TotalPartyActivityNum,
				          sum(cm.LastMonthPartyActivityNum) LastMonthPartyActivityNum
				
				          from  commonmgt.areacategory_area aca 
				          JOIN report.R_PartyBuilding_Report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)

			           #STRWHERE#  #WHERESTR#

			           -- GROUP BY  left(cm.ContractorCode,@codeLength)

								UNION ALL
                
                select 
				          left(cm.ContractorCode,@codeNextLength) ContractorCode,
				          sum(cm.PartyAuthNum)  PartyAuthNum,
				          sum(cm.PartyPendingAuthNum) PartyPendingAuthNum,
				          sum(cm.TotalPartyActivityNum)  TotalPartyActivityNum,
				          sum(cm.LastMonthPartyActivityNum) LastMonthPartyActivityNum
				
				          from  commonmgt.areacategory_area aca 
				          JOIN report.R_PartyBuilding_Report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)

			          #STRWHERE# AND  LENGTH(cm.ContractorCode) >=@codeNextLength #WHERESTR# 



			          GROUP BY  left(cm.ContractorCode,@codeNextLength)
          ) as  da   on da.ContractorCode=cm.ContractorCode
          LEFT JOIN
			          ( 	
								select 
										  left(cm.ContractorCode,@codeLength) ContractorCode,
											count(distinct cm.ParentProjectSysNo) IsPartyOrganization
											from  commonmgt.areacategory_area aca 
											JOIN report.R_PartyBuilding_Report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)
											 
											 WHERE cm.ContractorCode 
												LIKE @ContractorCodeLike  
											and exists (select 1 from report.R_PartyBuilding_Report b 
											WHERE cm.ParentProjectSysNo = b.ParentProjectSysNo AND b.ContractorCode  like @ContractorCodeLike
											and cm.IsPartyOrganization=1)
											 #WHERESTR#

								UNION ALL
								select 
											left(cm.ContractorCode,@codeNextLength) ContractorCode,
											count(distinct cm.ParentProjectSysNo) IsPartyOrganization					 
											from  commonmgt.areacategory_area aca 
											JOIN report.R_PartyBuilding_Report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)

											 
											 WHERE  cm.ContractorCode LIKE @ContractorCodeLike AND  LENGTH(cm.ContractorCode) >=@codeNextLength 
											and exists (select 1 from report.R_PartyBuilding_Report b 
											WHERE cm.ParentProjectSysNo = b.ParentProjectSysNo AND b.ContractorCode  like @ContractorCodeLike
											and cm.IsPartyOrganization = 1 )
											 #WHERESTR# 

										 GROUP BY  left(cm.ContractorCode,@codeNextLength)
								) as  pa   on pa.ContractorCode=cm.ContractorCode
							LEFT JOIN
			          ( 	
								select  
										left(cm.ContractorCode,@codeLength) ContractorCode,
										count(distinct cm.ParentProjectSysNo) NotPartyOrganization
										from commonmgt.areacategory_area aca 
                    JOIN report.R_PartyBuilding_Report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)
										WHERE cm.ContractorCode  like @ContractorCodeLike 
										and cm.IsPartyOrganization = 0 
										and cm.ParentProjectSysNo not in
										(select b.ParentProjectSysNo from report.R_PartyBuilding_Report b where b.ContractorCode like @ContractorCodeLike and b.IsPartyOrganization = 1 GROUP BY b.ParentProjectSysNo)	
										#WHERESTR#
							  union ALL
								select  
										left(cm.ContractorCode,@codeNextLength) ContractorCode,
										count(distinct cm.ParentProjectSysNo) NotPartyOrganization
										from commonmgt.areacategory_area   aca  
										JOIN report.R_PartyBuilding_Report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)
										WHERE cm.ContractorCode  like @ContractorCodeLike 
										and cm.IsPartyOrganization = 0 
										and cm.ParentProjectSysNo not in
										(select b.ParentProjectSysNo from report.R_PartyBuilding_Report b where b.ContractorCode like @ContractorCodeLike and b.IsPartyOrganization = 1 GROUP BY b.ParentProjectSysNo)	
										AND  LENGTH(cm.ContractorCode) >=@codeNextLength 
										#WHERESTR#
										GROUP BY  left(cm.ContractorCode,@codeNextLength)
								) as  na   on na.ContractorCode=cm.ContractorCode
           #STRWHERE# and (LENGTH(cm.ContractorCode)=@codeNextLength or length(cm.ContractorCode)=@codeLength)  and cm.`Status`=1


        
            ]]>
      </Text>
    </SQL>



    <!--原来采用job采集数据，统计的项目及人数SQL-->
    <SQL SQLKey="GetR_ProjectWorker_ReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          SELECT
	          cm.SysNo ContractorSysNo,
	          cm.ContractorCode,
	          cm.ContractorName,
	          IFNULL(in1.IsOnline, 0) IsOnline,
	          IFNULL(in1.IsNew, 0) IsNew,
            IFNULL(in1.IsNewWeek, 0) IsNewWeek,
	          IFNULL(in1.TotalProjectNum, 0) TotalProjectNum,
	          IFNULL(in2.EntryWorkerNum, 0) EntryWorkerNum,
	          IFNULL(in2.AttendanceTodayNum, 0) AttendanceTodayNum,
	          IFNULL(
		          in2.ProjectWorkerTotalNum,
		          0
	          ) ProjectWorkerTotalNum,
	          IFNULL(in2.SceneWorkerNum, 0) SceneWorkerNum,
            IFNULL(in2.NewWeekWorkerNum, 0) NewWeekWorkerNum,
	          IFNULL(in3.rate, 0) Rate,
	          1 StatContainContractorType
          FROM
	          projectmgt.contractormaster cm
          LEFT JOIN (
	          	SELECT
		            inCm.ContractorCode,
		            SUM(IFNULL(inDA.IsOnLine, 0)) IsOnLine,
		            SUM(IFNULL(inDA.IsNew, 0)) IsNew,
		            SUM(IFNULL(inDA.IsNewWeek, 0)) IsNewWeek,
		            SUM(
			            IFNULL(inDA.TotalProjectNum, 0)
		            ) TotalProjectNum
	            FROM
		            projectmgt.contractormaster inCm
	            LEFT JOIN (
		            SELECT
			            cm.ContractorCode,
			            sum(
				            CASE
				            WHEN pm.ContractorCode LIKE CONCAT(cm.ContractorCode, '%')
				            AND (
					            pm.Sysno = pm.ParentProjectSysNo
					            OR (
						            pm.SysNo <> pm.ParentProjectSysNo
						            AND pm.ParentContractorCode NOT LIKE CONCAT(cm.ContractorCode, '%')
					            )
					            OR (
						            pm.SysNo <> pm.ParentProjectSysNo
						            AND LENGTH(pm.ParentContractorCode) > LENGTH(pm.ContractorCode)
					            )
				            ) THEN
					            cm.IsOnline
				            ELSE
					            0
				            END
			            ) IsOnline,
			            sum(
				            CASE
				            WHEN pm.ContractorCode LIKE CONCAT(cm.ContractorCode, '%')
				            AND (
					            pm.Sysno = pm.ParentProjectSysNo
					            OR (
						            pm.SysNo <> pm.ParentProjectSysNo
						            AND pm.ParentContractorCode NOT LIKE CONCAT(cm.ContractorCode, '%')
					            )
					            OR (
						            pm.SysNo <> pm.ParentProjectSysNo
						            AND LENGTH(pm.ParentContractorCode) > LENGTH(pm.ContractorCode)
					            )
				            ) THEN
					            cm.IsNew
				            ELSE
					            0
				            END
			            ) IsNew,
			            sum(
				            CASE
				            WHEN pm.ContractorCode LIKE CONCAT(cm.ContractorCode, '%')
				            AND (
					            pm.Sysno = pm.ParentProjectSysNo
					            OR (
						            pm.SysNo <> pm.ParentProjectSysNo
						            AND pm.ParentContractorCode NOT LIKE CONCAT(cm.ContractorCode, '%')
					            )
					            OR (
						            pm.SysNo <> pm.ParentProjectSysNo
						            AND LENGTH(pm.ParentContractorCode) > LENGTH(pm.ContractorCode)
					            )
				            ) THEN
					            cm.IsNewWeek
				            ELSE
					            0
				            END
			            ) IsNewWeek,
			            sum(
				            CASE
				            WHEN pm.ContractorCode LIKE CONCAT(cm.ContractorCode, '%')
				            AND (
					            pm.Sysno = pm.ParentProjectSysNo
					            OR (
						            pm.SysNo <> pm.ParentProjectSysNo
						            AND pm.ParentContractorCode NOT LIKE CONCAT(cm.ContractorCode, '%')
					            )
					            OR (
						            pm.SysNo <> pm.ParentProjectSysNo
						            AND LENGTH(pm.ParentContractorCode) > LENGTH(pm.ContractorCode)
					            )
				            ) THEN
					            1
				            ELSE
					            0
				            END
			            ) TotalProjectNum
		            FROM
			            commonmgt.areacategory_area aca
		            INNER JOIN report.r_projectworker_report cm ON LEFT (cm.AreaCode, 2) = LEFT (aca.AreaCode, 2)
		            INNER JOIN projectmgt.projectmaster pm ON cm.projectsysno = pm.sysno
		            WHERE
			            1 = 1
		            AND cm.ContractorCode LIKE @ContractorCodeLike 
		            #WHERESTR#
		            GROUP BY
			            cm.ContractorCode
		            ORDER BY
			            cm.ContractorCode
	            ) AS inDa ON inDa.ContractorCode LIKE CONCAT(inCm.ContractorCode, '%')
	            WHERE
		            1 = 1
	            AND inCm.ContractorCode LIKE @ContractorCodeLike
	            AND (
		          LENGTH(inCm.ContractorCode) = @codeLength
		          OR length(inCm.ContractorCode) = @codeNextLength
	            )
	            AND inCm.`Status` = 1
	            GROUP BY
		            inCm.ContractorCode
          ) in1 ON cm.ContractorCode = in1.ContractorCode
          LEFT JOIN (
	          SELECT
		          inCm.ContractorCode,
		          sum(
			          IFNULL(inD2.EntryWorkerNum, 0)
		          ) EntryWorkerNum,
		          sum(
			          IFNULL(inD2.AttendanceTodayNum, 0)
		          ) AttendanceTodayNum,
		          sum(
			          IFNULL(inD2.SceneWorkerNum, 0)
		          ) SceneWorkerNum,
		          sum(
			          IFNULL(
				          inD2.ProjectWorkerTotalNum,
				          0
			          )
		          ) ProjectWorkerTotalNum,
             sum(
			          IFNULL(inD2.NewWeekWorkerNum, 0)
		          ) NewWeekWorkerNum
	          FROM
		          projectmgt.contractormaster inCm
	          LEFT JOIN (
		          SELECT
			          sum(cm.EntryWorkerNum) EntryWorkerNum,
			          sum(cm.AttendanceTodayNum) AttendanceTodayNum,
			          sum(cm.SceneWorkerNum) SceneWorkerNum,
			          sum(cm.ProjectWorkerTotalNum) ProjectWorkerTotalNum,
                sum(cm.NewWeekWorkerNum) NewWeekWorkerNum,
			          cm.ContractorCode ContractorCode
		          FROM
			          commonmgt.areacategory_area aca
		          JOIN report.r_projectworker_report cm ON LEFT (cm.AreaCode, 2) = LEFT (aca.AreaCode, 2)
		          WHERE
			          1 = 1 
		          #WHERESTR#
		          GROUP BY
			          cm.ContractorCode
	          ) AS inD2 ON inD2.ContractorCode LIKE concat(inCm.ContractorCode, '%')
	          WHERE
		          1 = 1
	          AND inCm.ContractorCode LIKE @ContractorCodeLike
	          AND (
		          LENGTH(inCm.ContractorCode) = @codeLength
		          OR length(inCm.ContractorCode) = @codeNextLength
	          )
	          AND inCm.`Status` = 1
	          GROUP BY
		          inCm.ContractorCode
          ) in2 ON cm.ContractorCode = in2.ContractorCode
          LEFT JOIN (
	          SELECT
		          inCm.ContractorCode,
		          sum(AttendanceWorkerNum) / sum(InWorkerNum) * 100 rate
	          FROM
		          projectmgt.contractormaster inCm
	          LEFT JOIN (
		          SELECT
			          pm.ContractorCode,
			          IFNULL(
				          sum(cm.AttendanceWorkerNum),
				          0
			          ) AttendanceWorkerNum,
			          IFNULL(sum(cm.InWorkerNum), 0) InWorkerNum
		          FROM
			          commonmgt.areacategory_area aca
		          JOIN projectmgt.projectmaster pm ON LEFT (pm.AreaCode, 2) = LEFT (aca.AreaCode, 2)
		          JOIN report.projectstatreport cm ON cm.projectSysNo = pm.SysNo
		          AND cm.Date >= @StartDate
		          AND cm.Date < @EndDate
		          WHERE
			          1 = 1
		          AND (
			          pm.ContractorCode LIKE @ContractorCodeLike
			          OR (
				          pm.ParentContractorCode LIKE @ContractorCodeLike
				          AND pm.ContractorCode NOT LIKE @ContractorCodeLike
			          )
		          ) 
		          #WHERESTR# 
		          GROUP BY
			          pm.ContractorCode
	          ) inD3 ON inD3.ContractorCode LIKE concat(inCm.ContractorCode, '%')
	          WHERE
		          1 = 1
	          AND inCm.ContractorCode LIKE @ContractorCodeLike
	          AND (
		          LENGTH(inCm.ContractorCode) = @codeLength
		          OR length(inCm.ContractorCode) = @codeNextLength
	          )
	          AND inCm.`Status` = 1
	          GROUP BY
		          inCm.ContractorCode
          ) in3 ON cm.ContractorCode = in3.ContractorCode
           
				  #STRWHERE# and  (LENGTH(cm.ContractorCode)=@codeLength or length(cm.ContractorCode)=@codeNextLength) and cm.`Status`=1
        
         
            ]]>
      </Text>
    </SQL>

    <!--获取在册工人数-->
    <SQL SQLKey="GetTotalWorkerCount" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          SELECT COUNT(DISTINCT a.WorkerSysNo) ProjectWorkerTotalNum
          FROM
            projectmgt.contractor_worker a
            INNER JOIN workermgt.workermaster b
              ON a.WorkerSysNo = b.sysno
            INNER JOIN projectmgt.contractormaster r
              ON a.ContractorSysNo = r.SysNo
          WHERE
            b.Status NOT IN (0, -999)
            AND a.Status NOT IN (0, -999)
            AND r.Status = 1
            AND r.ContractorCode LIKE CONCAT(@ContractorCode, '%');
        ]]>
      </Text>
    </SQL>

    <!--最新采用BA统计数据，统计的项目及人数SQL-->
    <SQL SQLKey="GetR_ProjectWorker_ReportList_New" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
SELECT
	cm.SysNo ContractorSysNo,
	cm.ContractorCode,
	cm.ContractorName,
	IFNULL(t2.EntryWorkerNum, 0) EntryWorkerNum,
	IFNULL(t1.OnlineProjectNum, 0) IsOnline,
	IFNULL(t1.TotalProjectNum, 0) TotalProjectNum,
	IFNULL(t1.TotalWorkerNum, 0) ProjectWorkerTotalNum,
	IFNULL(t1.NewProjectNum_CurWeek, 0) IsNew,
	IFNULL(t2.AttendanceTodayNum, 0) AttendanceTodayNum,
	IFNULL(t2.SceneWorkerNum, 0) SceneWorkerNum,
  t2.EditDate,
	IFNULL(t2.rate, 0) rate
FROM
	projectmgt.contractormaster cm
LEFT JOIN (
	SELECT
		lr.ContractorCode,
		lr.ContractorName,
		lr.AreaCode,
		lr.TotalProjectNum,
		lr.OnlineProjectNum,
    lr.NewProjectNum_CurWeek,
		(lr.TotalWorkerNum_Labor+lr.TotalWorkerNum_NonLabor) TotalWorkerNum,
		(lr.EntryWorkerNum_Labor+lr.entryworkernum_NonLabor) EntryWorkerNum
	FROM
		report.r_laborweek_report lr
	WHERE
		lr.ContractorCode LIKE @ContractorCodeLike
    and lr.ContractorType = @ContractorType
	AND (
		LENGTH(lr.ContractorCode) = @codeLength
		OR LENGTH(lr.ContractorCode) = @codeNextLength
	)
	AND lr.AreaCode = @AreaCode
) t1 ON cm.ContractorCode = t1.ContractorCode
LEFT JOIN (
	SELECT
		inCm.ContractorCode,
    sum(inD2.EntryWorkerNum) EntryWorkerNum,
		sum(
			IFNULL(inD2.AttendanceTodayNum, 0)
		) AttendanceTodayNum,
		sum(
			IFNULL(inD2.SceneWorkerNum, 0)
		) SceneWorkerNum,
    sum(inD2.AttendanceWorkerNum) / sum(inD2.InWorkerNum) * 100 rate,
    inD2.EditDate
	FROM
		projectmgt.contractormaster inCm
	LEFT JOIN (
		SELECT
			sum(cm.AttendanceTodayNum+cm.AttendanceTodayNumForSubContractor) AttendanceTodayNum,
			sum(cm.SceneWorkerNum+cm.SceneWorkerNumForSubContractor) SceneWorkerNum,
			sum(cm.AttendanceWorkerNum+cm.AttendanceWorkerNumForSubContractor) AttendanceWorkerNum,
			sum(cm.InWorkerNum+cm.InWorkerNumForSubContractor) InWorkerNum,
      sum(cm.EntryWorkerNum+cm.EntryWorkerNumForSubContractor) EntryWorkerNum,
			cm.ContractorCode ContractorCode,
			cm.EditDate
		FROM
			commonmgt.areacategory_area aca
		JOIN report.r_projectworker_report cm ON LEFT (cm.AreaCode, 2) = LEFT (aca.AreaCode, 2)
		WHERE
     cm.ContractorType = @ContractorType
     #WHERESTR#
		GROUP BY
			cm.ContractorCode
	) AS inD2 ON inD2.ContractorCode LIKE concat(inCm.ContractorCode, '%')
	WHERE
		inCm.ContractorCode LIKE @ContractorCodeLike
	AND (
		LENGTH(inCm.ContractorCode) = @codeLength
		OR length(inCm.ContractorCode) = @codeNextLength
	)
	AND inCm.`Status` = 1
	GROUP BY
		inCm.ContractorCode
) t2 ON cm.ContractorCode = t2.ContractorCode
WHERE
	cm.ContractorCode LIKE @ContractorCodeLike2
AND (
	LENGTH(cm.ContractorCode) =@codeLength
	OR length(cm.ContractorCode) =@codeNextLength
)
AND cm.`Status` = 1
ORDER BY
	cm.ContractorCode
        ]]>
      </Text>
    </SQL>

<!--获取在场人数-->
    <SQL SQLKey="GetR_CurrentInWorkerNum" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
        
SELECT
	t1.CurrentInWorkerNum,
	t1.ContractorCode
FROM
	report.r_projectworker_report t1
INNER JOIN commonmgt.area t2 on t2.SortCode=t1.AreaCode
#STRWHERE#
;

        ]]>
      </Text>
    </SQL>
    
    <SQL SQLKey="BatchInsertR_ProjectWorker_Report" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[ 
          $BATCHINSERT${[
         
          INSERT INTO report.r_projectworker_report
          (
            ContractorSysNo
          , ContractorCode
          , ContractorName
          , AreaCode
          , ProjectSysNo
          , IsOnline
          , IsNew
          , ProjectWorkerTotalNum
          , EntryWorkerNum
          , EntryWorkerNumForSubContractor
          , SceneWorkerNum
          , SceneWorkerNumForSubContractor
          , AttendanceTodayNum
          , AttendanceTodayNumForSubContractor
          , EditUserName
          , EditDate
          , IsNewWeek
          , NewWeekWorkerNum
          , InWorkerNum
          , InWorkerNumForSubContractor
          , AttendanceWorkerNum
          , AttendanceWorkerNumForSubContractor
          , Rate
          , RateForSubContractor
          , ContractorType
          , ParentContractorCode
          ,SpecialContractorNum
          ,SubContractorNum
          ,WorkerTeamNum
          ,WorkerTeamNumForSubContractor
          ,CurrentInWorkerNum
          )
            VALUES
              (
           @ContractorSysNo
          , @ContractorCode
          , @ContractorName
          , @AreaCode
          , @ProjectSysNo
          , @IsOnline
          , @IsNew
          , @ProjectWorkerTotalNum
          , @EntryWorkerNum
          , @EntryWorkerNumForSubContractor
          , @SceneWorkerNum
          , @SceneWorkerNumForSubContractor
          , @AttendanceTodayNum
          , @AttendanceTodayNumForSubContractor
          , @EditUserName
          , @EditDate
          , @IsNewWeek
          , @NewWeekWorkerNum
          , @InWorkerNum
          , @InWorkerNumForSubContractor
          , @AttendanceWorkerNum
          , @AttendanceWorkerNumForSubContractor
          , @Rate
          , @RateForSubContractor
          , @ContractorType
          , @ParentContractorCode
          , @SpecialContractorNum
          , @SubContractorNum
          , @WorkerTeamNum
          , @WorkerTeamNumForSubContractor
          , @CurrentInWorkerNum
              );

          ]}
          ]]>
      </Text>
    </SQL>


    <SQL SQLKey="BatchInsertOrUpdateR_ProjectWorker_Report" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[ 
             INSERT INTO 
                report.r_projectworker_report 
              (
                ContractorSysNo
               ,ContractorCode
               ,ContractorName
               ,AreaCode
               ,ProjectSysNo
               ,IsOnline
               ,IsNew
               ,ProjectWorkerTotalNum
               ,EntryWorkerNum
               ,SceneWorkerNum
               ,AttendanceTodayNum
               ,EditUserName
               ,EditDate
               ,IsNewWeek
               ,NewWeekWorkerNum
               ,InWorkerNum
               ,AttendanceWorkerNum
               ,Rate
               ,ContractorType
               ,ParentContractorCode
               ,SpecialContractorNum
               ,SubContractorNum
               ,WorkerTeamNum
               ,CurrentInWorkerNum
               ,EntryWorkerNumForSubContractor
               ,AttendanceTodayNumForSubContractor
               ,AttendanceWorkerNumForSubContractor
               ,InWorkerNumForSubContractor
               ,RateForSubContractor
               ,WorkerTeamNumForSubContractor
               ,SceneWorkerNumForSubContractor
              )
              VALUES
              /*MappingValues{[(
                {0}
               ,'{1}'
               ,'{2}'
               ,'{3}'
               ,{4}
               ,{5}
               ,{6}
               ,{7}
               ,{8}
               ,{9}
               ,{10}
               ,'{11}'
               ,Now()
               ,{12}
               ,{13}
               ,{14}
               ,{15}
               ,{16}
               ,{17}
               ,'{18}'
               ,{19}
               ,{20}
               ,{21}
               ,{22}
               ,{23}
               ,{24}
               ,{25}
               ,{26}
               ,{27}
               ,{28}
               ,{29}
              )]}*/
                  ON DUPLICATE KEY UPDATE IsOnline=VALUES(IsOnline),
              IsNew=VALUES(IsNew),
              ProjectWorkerTotalNum=VALUES(ProjectWorkerTotalNum),
              EntryWorkerNum=VALUES(EntryWorkerNum),
              SceneWorkerNum=VALUES(SceneWorkerNum),
              AttendanceTodayNum=VALUES(AttendanceTodayNum),
              EditDate=Now(),
              IsNewWeek=VALUES(IsNewWeek),
              NewWeekWorkerNum=VALUES(NewWeekWorkerNum),
              InWorkerNum=VALUES(InWorkerNum),
              AttendanceWorkerNum=VALUES(AttendanceWorkerNum),
              Rate=VALUES(Rate),
              SpecialContractorNum=VALUES(SpecialContractorNum),
              SubContractorNum=VALUES(SubContractorNum),
              WorkerTeamNum=VALUES(WorkerTeamNum),
              CurrentInWorkerNum=VALUES(CurrentInWorkerNum),
              EntryWorkerNumForSubContractor=VALUES(EntryWorkerNumForSubContractor),
              AttendanceTodayNumForSubContractor=VALUES(AttendanceTodayNumForSubContractor),
              AttendanceWorkerNumForSubContractor=VALUES(AttendanceWorkerNumForSubContractor),
              InWorkerNumForSubContractor=VALUES(InWorkerNumForSubContractor),
              RateForSubContractor=VALUES(RateForSubContractor),
              WorkerTeamNumForSubContractor=VALUES(WorkerTeamNumForSubContractor),
              SceneWorkerNumForSubContractor=VALUES(SceneWorkerNumForSubContractor)
          ]]>
      </Text>
    </SQL>

    <SQL SQLKey="DeleteAllR_ProjectWorker_Report" ConnectionKey="ReportWrite">
      <Text>
        <![CDATA[ 
         Delete from Report.R_ProjectWorker_Report;
          ]]>
      </Text>
    </SQL>
    
    <SQL SQLKey="GetR_SubContractorRankHome_ReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
       
       select 
        SysNo,
        ContractorSysNo,
        ContractorCode,
        ContractorName,
        SubContractorSysNo,
        SubContractorName,
        AreaCode,
        ProjectNum,
        TotalWorkerNum,
        EntryTeamNum,
        EntryWorkerNum,
        TotalWorkHours,
        TotalManualWorkHours,
        TotalPayRoll,
        RegisteredWorkerNum,
        EditUserName,
        EditDate
       from Report.r_subcontractorrankhome_report 
       #STRWHERE#  
              ORDER BY ProjectNum desc
LIMIT 10
       
            ]]>
      </Text>
    </SQL>

    <!--获取需要统计项目及人数统计的组织机构-->
    <SQL SQLKey="GetR_Contractormaster_OrganCode" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
      select cm.ContractorCode from projectmgt.contractormaster cm
        where ContractorCode like @ContractorCodeLike and  (LENGTH(cm.ContractorCode)=@codeNextLength or length(cm.ContractorCode)=@codeLength) and cm.`Status`=1       
            ]]>
      </Text>
    </SQL>

    <!--获取需要统计项目及人数统计指定组织机构下具体的统计数据-->
    <SQL SQLKey="GetR_ProjectWorker_Reportlist_OrganCode" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          select 
		            cm.SysNo ContractorSysNo,
                cm.ContractorCode,
			          cm.ContractorName,
			          IFNULL(d2.EntryWorkerNum ,0) EntryWorkerNum,
			          IFNULL(d2.AttendanceTodayNum ,0) AttendanceTodayNum,
			          IFNULL(d2.ProjectWorkerTotalNum ,0) ProjectWorkerTotalNum,
			          IFNULL(d2.SceneWorkerNum ,0) SceneWorkerNum,
			          IFNULL(da.IsOnline ,0) IsOnline,
			          IFNULL(da.IsNew ,0) IsNew,
                IFNULL(da.TotalProjectNum,0) TotalProjectNum,
                IFNULL(re.rate,0) Rate,
			          1  StatContainContractorType
			          from projectmgt.contractormaster cm
			          LEFT JOIN
			          (
                
								select 
				          @ContractorCode ContractorCode,
				          sum(cm.IsOnline)  IsOnline,
				          sum(cm.IsNew) IsNew,
                  count(1) TotalProjectNum
				
				             from commonmgt.areacategory_area aca 
				          JOIN report.r_projectworker_report cm on left(cm.AreaCode,2)=left(aca.AreaCode,2)

                   
			           WHERE cm.ContractorCode LIKE @ContractorCodeLike   #WHERESTR#
          ) as  da   on da.ContractorCode=cm.ContractorCode
          JOIN(
							SELECT 
												sum(cm.EntryWorkerNum) EntryWorkerNum,
												sum(cm.AttendanceTodayNum) AttendanceTodayNum,
												sum(cm.SceneWorkerNum) SceneWorkerNum,
												sum(cm.ProjectWorkerTotalNum) ProjectWorkerTotalNum,
												cm.AreaCode,
												@ContractorCode ContractorCode
							FROM commonmgt.areacategory_area aca 
							JOIN
								(select
												rp.EntryWorkerNum,
												rp.AttendanceTodayNum,
												rp.SceneWorkerNum,
												rp.ProjectWorkerTotalNum,
												rp.AreaCode,
												rp.ContractorCode
									from report.r_projectworker_report rp 
								RIGHT JOIN
									(select p.SysNo from projectmgt.projectmaster p 
																where ContractorCode like @ContractorCodeLike or ParentContractorCode like @ContractorCodeLike
									) pm
								on rp.projectSysNo = pm.SysNo) cm
							on left(cm.AreaCode,2)=left(aca.AreaCode,2)
              
						  #WHERESTR#
              
					)d2 on da.ContractorCode=d2.ContractorCode
          JOIN (
          
            select 
             @ContractorCode ContractorCode, sum(cm.AttendanceWorkerNum)/sum(cm.InWorkerNum)*100 rate
            from report.projectstatreport cm 
            join projectmgt.projectmaster pm on cm.ProjectSysNo = pm.SysNo
            join commonmgt.areacategory_area aca  on left(pm.AreaCode,2)=left(aca.AreaCode,2) 
            where cm.Date >=@StartDate and cm.Date <@EndDate
            and (pm.ContractorCode like @ContractorCodeLike or pm.ParentContractorCode like @ContractorCodeLike)
            
						#WHERESTR#
          ) re on re.ContractorCode=da.ContractorCode
					where cm.ContractorCode = @ContractorCode  
            ]]>
      </Text>
    </SQL>

    <!--查看指定企业及其下级的项目统计数据-->
    <SQL SQLKey="GetContractorProjectByProjectType" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
        SELECT
	        ct.DictCode `Code`,
	        ct.DictName `Name`
        FROM
	        commonmgt.commondict ct
        WHERE
	        ct.DictTypeKey = '001'
        ORDER BY
	        ct.DictCode;

        SELECT
	        cm.ContractorCode,
	        cm.ContractorName,
	        (
		        SELECT
			        COUNT(c.ContractorCode)
		        FROM
			        projectmgt.contractormaster c
		        WHERE
			        c.ContractorCode <> cm.ContractorCode
		        AND c.ContractorCode LIKE CONCAT(cm.ContractorCode, '%')
		        AND LENGTH(c.ContractorCode) = (
			        LENGTH(cm.ContractorCode) + 4
		        )
	        ) IsLowerLevel
        FROM
	        projectmgt.contractormaster cm
        WHERE
	        cm.ContractorCode LIKE @ContractorCodeLike
          and cm.`Status` = 1
        AND (
	        LENGTH(cm.ContractorCode) =@CodeLength
	        OR LENGTH(cm.ContractorCode) = @CodeEndLength
        )
        ORDER BY
	        cm.SysNo;

        /*TagWhereRangeTypeYear{[ AND rl.ProjectYear={0} ]}*/    
        /*TagWhereRangeTypeQuarter{[ AND rl.ProjectMonth in ({0},{1},{2}) ]}*/
        /*TagWhereRangeTypeMonth{[ AND rl.ProjectMonth = {0} ]}*/
        /*TagWhereRangeTypeSelect{[ AND rl.ProjectDate >= '{0}' and rl.ProjectDate <='{1}' ]}*/

          #SELECTUNION#
            ]]>
      </Text>
    </SQL>
    
    <!--查看指定企业及其下级的项目统计数据 这个sql语句保存的查询本级汇总数据的sql，只有配合着GetContractorProjectByProjectType的时候才能使用-->
    <SQL SQLKey="GetContractorProjectByProjectTypeQueryMaster" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          SELECT
	          0 levelType,
	          LEFT (
		          rl.ContractorCode ,@CodeLength
	          ) ContractorCode,
	          rl.ProjectTypeCode `Code`,
	          rl.ProjectTypeName `Name`,
	          count(1) Number
          FROM
	          report.R_ContractorProject_Level_Report rl
          WHERE
	          rl.ProjectStatus = 0 
            and rl.ProjectSysNo = rl.ParentProjectSysNo 
            #STRWHERE#
          AND rl.ContractorCode LIKE @ContractorCodeLike
          GROUP BY
	          LEFT (
		          rl.ContractorCode ,@CodeLength
	          ),
	          rl.ProjectTypeCode;

            ]]>
      </Text>
    </SQL>

    <!--查看指定企业及其下级的项目统计数据 这个sql语句保存的查询本级、下级汇总数据的sql，只有配合着GetContractorProjectByProjectType的时候才能使用-->
    <SQL SQLKey="GetContractorProjectByProjectTypeAll" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
        
SELECT
	1 levelType,
	rl.ContractorCode,
	rl.ProjectTypeCode `Code`,
	rl.ProjectTypeName `Name`,
	count(1) Number
FROM
	report.R_ContractorProject_Level_Report rl
WHERE
	rl.ProjectStatus = 0 
  and rl.ProjectSysNo = rl.ParentProjectSysNo
  #STRWHERE#
AND rl.ContractorCode = @ContractorCode
GROUP BY
	rl.ContractorCode,
	rl.ProjectTypeCode;

SELECT
	2 levelType,
	LEFT (
		rl.ContractorCode ,@CodeEndLength
	) ContractorCode,
	rl.ProjectTypeCode `Code`,
	rl.ProjectTypeName `Name`,
	count(1) Number
FROM
	report.R_ContractorProject_Level_Report rl
WHERE
	rl.ProjectStatus = 0 
  and rl.ProjectSysNo = rl.ParentProjectSysNo
  #STRWHERE#
AND rl.ContractorCode LIKE @ContractorCodeLike
AND LENGTH(rl.ContractorCode) >=@CodeEndLength
GROUP BY
	LEFT (
		rl.ContractorCode ,@CodeEndLength
	),
	rl.ProjectTypeCode;
            ]]>
      </Text>
    </SQL>

    
    
    <!--查看指定企业及其下级的项目统计数据 该sql只返回列头集合和行对象数量，具体的行对象列值集合，需要配合GetContractorProjectByAreaCodeQuerMaster与GetContractorProjectByAreaCodeAll两个sql语句拼接使用-->
    <SQL SQLKey="GetContractorProjectByAreaCode" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
        
        DROP TEMPORARY TABLE IF EXISTS commonmgt.temp_area;  

        /*TagCreateAraeQG{[ 
              CREATE TEMPORARY TABLE commonmgt.temp_area SELECT ace.`Code` AreaCode,ace.`Name` AreaName  
          from 	commonmgt.areacategory ace
          where ace.`Code` <> '{0}'; ]}*/   


        /*TagCreateAraeQY{[ 
             CREATE TEMPORARY TABLE commonmgt.temp_area select 
	        ace.AreaCode,
	        a.`NAME` AreaName
        FROM
	        commonmgt.areacategory_area ace
        JOIN commonmgt.area a ON a.`Code` = ace.AreaCode
        where ace.AreaCategoryCode and ace.AreaCategoryCode='{0}'; ]}*/   

        /*TagCreateAraeZXS{[ 
             CREATE TEMPORARY TABLE commonmgt.temp_area select a.`Code` AreaCode,a.`Name` AreaName from commonmgt.area a  where code  = '{0}'; ]}*/ 

  
        /*TagCreateAraeSF{[ 
             CREATE TEMPORARY TABLE commonmgt.temp_area 
		         select a.`Code` AreaCode,a.`Name` AreaName from commonmgt.area a where LEFT(`Code`,2) = left('{0}',2) and `Code`<>'{1}' group by LEFT(`Code`,4); ]}*/ 
        
        /*TagCreateAraeGAT{[ 
            CREATE TEMPORARY TABLE commonmgt.temp_area 
		        select a.`Code` AreaCode,a.`Name` AreaName from commonmgt.area a where LEFT(`Code`,2) = left('{0}',2)  group by LEFT(`Code`,4); ]}*/ 
        
        SELECT AreaCode `Code`,AreaName `Name` FROM commonmgt.temp_area;

        SELECT
	        cm.ContractorCode,
	        cm.ContractorName,
	        (
		        SELECT
			        COUNT(c.ContractorCode)
		        FROM
			        projectmgt.contractormaster c
		        WHERE
			        c.ContractorCode <> cm.ContractorCode
		        AND c.ContractorCode LIKE CONCAT(cm.ContractorCode, '%')
		        AND LENGTH(c.ContractorCode) = (
			        LENGTH(cm.ContractorCode) + 4
		        )
	        ) IsLowerLevel
        FROM
	        projectmgt.contractormaster cm
        WHERE
	        cm.ContractorCode LIKE @ContractorCodeLike
          and cm.`Status` = 1
        AND (
	        LENGTH(cm.ContractorCode) =@CodeLength
	        OR LENGTH(cm.ContractorCode) = @CodeEndLength
        )
        ORDER BY
	        cm.SysNo;
          
        /*TagJoinWhereQG{[ JOIN commonmgt.areacategory_area ace ON left(rl.AreaCode,2) = LEFT(ace.AreaCode,2) JOIN commonmgt.temp_area ta on ace.AreaCategoryCode = ta.AreaCode  ]}*/    
        /*TagJoinWhereQY{[ JOIN commonmgt.areacategory_area ace ON left(rl.AreaCode,2) = LEFT(ace.AreaCode,2) JOIN commonmgt.temp_area ta on ace.AreaCode = ta.AreaCode  ]}*/  
        /*TagJoinWhereZXS{[ JOIN commonmgt.areacategory_area ace ON left(rl.AreaCode,2) = LEFT(ace.AreaCode,2) JOIN commonmgt.temp_area ta on ace.AreaCode = ta.AreaCode  ]}*/  
        /*TagJoinWhereSF{[ JOIN commonmgt.temp_area ta on left(rl.AreaCode, 4) = left(ta.AreaCode, 4)  ]}*/  
        
        
        
        /*TagWhereRangeTypeYear{[ AND rl.ProjectYear={0} ]}*/    
        /*TagWhereRangeTypeQuarter{[ AND rl.ProjectMonth in ({0},{1},{2}) ]}*/
        /*TagWhereRangeTypeMonth{[ AND rl.ProjectMonth = {0} ]}*/
        /*TagWhereRangeTypeSelect{[ AND rl.ProjectDate >= '{0}' and rl.ProjectDate <='{1}' ]}*/
                
        #SELECTUNION#

        
            ]]>
      </Text>
    </SQL>


    <!--查看指定企业及其下级的项目统计数据-->
    <SQL SQLKey="GetContractorProjectByAreaCodeQueryMaster" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
        
    select 0 levelType,
			LEFT (
				rl.ContractorCode ,@CodeLength
			) ContractorCode,
			ta.AreaCode `Code`,
			ta.AreaName `Name`,
			count(1)  `Number`
       from report.r_contractorproject_level_report rl
      #JOINWHERE#
      WHERE
			ProjectStatus = 0
      and rl.ProjectSysNo = rl.ParentProjectSysNo
       #STRWHERE#
		AND rl.ContractorCode LIKE @ContractorCodeLike
		GROUP BY
			ta.AreaCode,
			LEFT (
				rl.ContractorCode ,@CodeLength
			);


            ]]>
      </Text>
    </SQL>
    
    <!--查看指定企业及其下级的项目统计数据 这个sql语句保存的查询本级、下级汇总数据的sql，只有配合着GetContractorProjectByAreaCodeQueryMaster的时候才能使用-->
    <SQL SQLKey="GetContractorProjectByAreaCodeAll" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
    SELECT
			1 levelType,
			LEFT (
				rl.ContractorCode ,@CodeLength
			) ContractorCode,
			ta.AreaCode `Code`,
			ta.AreaName `Name`,
			count(1)  `Number`
		FROM
			report.r_contractorproject_level_report rl
		#JOINWHERE#
		WHERE
			ProjectStatus = 0
      and rl.ProjectSysNo = rl.ParentProjectSysNo
       #STRWHERE#
		AND rl.ContractorCode = @ContractorCode
		GROUP BY
			ta.AreaCode,
			LEFT (
				rl.ContractorCode ,@CodeLength
			);

    SELECT
			2 levelType,
			LEFT (
				rl.ContractorCode ,@CodeEndLength
			) ContractorCode,
		  ta.AreaCode `Code`,
			ta.AreaName `Name`,
			count(1)  `Number`
		FROM
			report.r_contractorproject_level_report rl
		#JOINWHERE#
		WHERE
			ProjectStatus = 0
      and rl.ProjectSysNo = rl.ParentProjectSysNo
       #STRWHERE#
		AND rl.ContractorCode LIKE @ContractorCodeLike
		AND LENGTH(rl.ContractorCode) >= @CodeEndLength
		GROUP BY
			ta.AreaCode,
			LEFT (
				rl.ContractorCode ,@CodeEndLength
			);
      
            ]]>
      </Text>
    </SQL>

    <!--综合变化量统计-->
    <!-- 获取RComprehensivechangeReport信息 -->
    <SQL SQLKey="GetRcomprehensiveChangeReportList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
             SELECT 
                `SysNo`
                ,`ProjectSysNo`
                ,`ProjectName`
                ,`SubContractorSysNo`
                ,`SubContractorName`
                ,`WorkTypeSysNo`
                ,`WorkTypeName`
                ,`ComprehensiveType`
                ,`StatRange`
                ,`StatRangeSort`
                ,`EntryWorkerNum`
                ,`TotalWorkHours`
                ,`TotalManualWorkHours`
                ,`StatStandardType`	
             FROM Report.r_comprehensivechange_report 
             #STRWHERE#
          ]]>
      </Text>
    </SQL>

    <!-- 加载RComprehensivechangeReport信息 -->
    <SQL SQLKey="GetAttendanceDay" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
            SELECT PT.ProjectSysNo
                 , PT.ContractorCode
                 , PT.TeamSysNo
                 , PT.Date
                 , PT.INWORKERNUM
                 , PT.ATTENDANCEWORKERNUM
                 , PS.ContractorType
            FROM report.projectstatreport PT
            INNER JOIN projectmgt.project_subcontractor PS
              ON PT.ProjectSysNo = PS.ProjectSysNo
                AND PT.SubContractorSysNo = PS.SubContractorSysNo
            WHERE PT.Date >= @DateBefore7
              AND PT.Date < @DateAfter1
              #AND PS.ContractorType = @ContractorType
          ]]>
      </Text>
    </SQL>

    <!-- 加载出勤记录信息 -->
    <SQL SQLKey="GetAttendanceDayByFilter" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
            SELECT PT.ProjectSysNo
                 , PT.ContractorCode
                 , PT.TeamSysNo
                 , PT.INWORKERNUM
                 , PT.ATTENDANCEWORKERNUM
                 , PT.SubContractorName
                 , PS.SubContractorSysNo
            FROM report.projectstatreport PT
            INNER JOIN projectmgt.project_subcontractor PS
              ON PT.ProjectSysNo = PS.ProjectSysNo
                AND PT.SubContractorSysNo = PS.SubContractorSysNo
            #STRWHERE#
              
              
          ]]>
      </Text>
    </SQL>

    <!-- 加载出勤记录信息，根据分包分组 只统计专业承包和劳务分包的数据-->
    <SQL SQLKey="GetAttendanceInfoGroupBySubContractor" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
SELECT
	sum(pt.AttendanceWorkerNum) as AttendanceWorkerNum,
	sum(PT.InWorkerNum) as InWorkerNum,
	PS.SubContractorSysNo
FROM
	report.projectstatreport PT
INNER JOIN projectmgt.project_subcontractor PS ON PT.ProjectSysNo = PS.ProjectSysNo
AND PT.SubContractorSysNo = PS.SubContractorSysNo
INNER JOIN projectmgt.projectmaster t2 on t2.sysno=PT.projectSysNo
#STRWHERE#
and t2.status=1
and PS.ContractorType in(1,2)
GROUP BY
	PS.SubContractorSysNo
order by pt.AttendanceWorkerNum desc
          ]]>
      </Text>
    </SQL>

    <!-- 查询项目人员信息 -->
    <SQL SQLKey="QueryProjectWorkerListReport" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
            SELECT COUNT(1) AS TOTALCOUNT
            FROM report.r_project_worker_report RPWR
            LEFT JOIN report.r_projectworker_report RPR
              ON RPWR.ProjectSysNo = RPR.ProjectSysNo
                AND RPWR.ContractorSysNo = RPR.ContractorSysNo
            Inner JOIN projectmgt.projectmaster P
              ON RPWR.ProjectSysNo = P.SysNo
            LEFT JOIN commonmgt.commondict C
              ON P.ProjectCategory = C.SysNo
            LEFT JOIN commonmgt.area A
              ON P.AreaCode = A.SortCode
            LEFT JOIN commonmgt.area AREA1
              ON AREA1.SortCode = LEFT(P.AreaCode, 2)
            LEFT JOIN commonmgt.area AREA2
              ON AREA2.SortCode = LEFT(P.AreaCode, 4)
            #STRWHERE#
            
             /*TagCanSeePrj{[  
                AND EXISTS
                    (
                      SELECT 1
                      FROM projectmgt.contractoruser_project T4
                      WHERE T4.ProjectSysNo = P.SysNo
                        AND T4.ContractorUserSysNo = {0})
                ]}*/ 
             ;
            SELECT RPWR.ProjectSysNo
                  , RPWR.ParentProjectSysNo
                  , P.ProjectName
                  , RPWR.ContractorCode
                  , RPWR.ContractorName
                  , RPWR.ContractorSysNo
                  , (RPWR.TotalWorkerNum_Labor+RPWR.TotalWorkerNum_NonLabor) TotalWorkerNum
                  , (RPR.EntryWorkerNum+RPR.EntryWorkerNumForSubContractor) EntryWorkerNum
	                , (RPR.SceneWorkerNum+RPR.SceneWorkerNumForSubContractor) SceneWorkerNum
	                , (RPR.AttendanceTodayNum+RPR.AttendanceTodayNumForSubContractor) AttendanceTodayNum
                  , RPR.SpecialContractorNum
                  , RPR.SubContractorNum
                  , (RPR.WorkerTeamNumForSubContractor) WorkerTeamNum
                  , C.DictName
                  , A.Name
                  , AREA1.Name AS AREAPROVINCENAME
                  , AREA2.Name AS AREACITYNAME
                  ,(
		                  (RPR.AttendanceWorkerNum+RPR.AttendanceWorkerNumForSubContractor) * 100 / (RPR.InWorkerNum+RPR.InWorkerNumForSubContractor)
	                  ) AS Rate
                  ,(RPR.AttendanceWorkerNum+RPR.AttendanceWorkerNumForSubContractor) AttendanceWorkerNum
	                ,(RPR.InWorkerNum+RPR.InWorkerNumForSubContractor) InWorkerNum
            FROM report.r_project_worker_report RPWR
            LEFT JOIN report.r_projectworker_report RPR
              ON RPWR.ProjectSysNo = RPR.ProjectSysNo
                AND RPWR.ContractorSysNo = RPR.ContractorSysNo
            Inner JOIN projectmgt.projectmaster P
              ON RPWR.ProjectSysNo = P.SysNo
            LEFT JOIN commonmgt.commondict C
              ON P.ProjectCategory = C.SysNo
            LEFT JOIN commonmgt.area A
              ON P.AreaCode = A.SortCode
            LEFT JOIN commonmgt.area AREA1
              ON AREA1.SortCode = LEFT(P.AreaCode, 2)
            LEFT JOIN commonmgt.area AREA2
              ON AREA2.SortCode = LEFT(P.AreaCode, 4)
              #STRWHERE#
              /*TagCanSeePrj{[  
                AND EXISTS
                    (
                      SELECT 1
                      FROM projectmgt.contractoruser_project T4
                      WHERE T4.ProjectSysNo = P.SysNo
                        AND T4.ContractorUserSysNo =  {0})
                ]}*/ 
            ORDER BY @SortFields  LIMIT @StartNum, @PageSize;
          ]]>
      </Text>
    </SQL>

    <!-- 查询工资信息 -->
    <SQL SQLKey="QueryProjectPayRollReport" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
             SELECT COUNT(1) AS TOTALCOUNT
              FROM
                ( Select RPWR.ProjectSysNo
                    , RPWR.ParentProjectSysNo
                    , P.ProjectName
                    , RPWR.ContractorCode
                    , RPWR.ContractorName
                    , RPWR.ContractorSysNo 
                    , SUM(RPRR.IsEntryWorker) AS ISENTRYWORKER
               FROM report.r_project_worker_report RPWR
                 INNER JOIN projectmgt.projectmaster P
                  ON RPWR.ProjectSysNo = P.SysNo
                LEFT JOIN report.r_contractor_payroll_report RPRR
                  ON RPWR.ProjectSysNo = RPRR.ProjectSysNo
                    AND RPWR.ContractorSysNo = RPRR.ContractorSysNo
                LEFT JOIN commonmgt.commondict C
                  ON P.ProjectCategory = C.SysNo
                INNER JOIN commonmgt.area A
                  ON P.AreaCode = A.SortCode
             #STRWHERE#
               /*TagMainContractor{[  
                  And RPWR.ProjectSysNo = RPWR.ParentProjectSysNo
                ]}*/ 
               
                /*TagSpecialContractor{[  
                   And RPWR.ProjectSysNo != RPWR.ParentProjectSysNo 
                ]}*/ 
                
                
              /*TagCanSeePrj{[  
                AND EXISTS
                    (
                      SELECT 1
                      FROM projectmgt.contractoruser_project T4
                      WHERE T4.ProjectSysNo = P.SysNo
                        AND T4.ContractorUserSysNo =  {0})
                ]}*/ 
           
              GROUP BY RPWR.ProjectSysNo
                      , RPWR.ParentProjectSysNo
                      , P.ProjectName
                      , RPWR.ContractorCode
                      , RPRR.ContractorName
                      , RPWR.ContractorSysNo
              )T ;


SELECT T.ProjectSysNo
     , T.ParentProjectSysNo
     , T.ProjectName
     , T.ContractorCode
     , T.ContractorName
     , T.ContractorSysNo
     , T.ISENTRYWORKER
FROM (
              SELECT RPWR.ProjectSysNo
                   , RPWR.ParentProjectSysNo
                   , P.ProjectName
                   , RPWR.ContractorCode
                   , RPWR.ContractorName
                   , RPWR.ContractorSysNo
                   , SUM(RPRR.IsEntryWorker) AS ISENTRYWORKER
           FROM report.r_project_worker_report RPWR
             INNER JOIN projectmgt.projectmaster P
                ON RPWR.ProjectSysNo = P.SysNo
            LEFT JOIN report.r_contractor_payroll_report RPRR
              ON RPWR.ProjectSysNo = RPRR.ProjectSysNo
                AND RPWR.ContractorSysNo = RPRR.ContractorSysNo
              LEFT JOIN commonmgt.commondict C
                ON P.ProjectCategory = C.SysNo
              INNER JOIN commonmgt.area A
                ON P.AreaCode = A.SortCode
                  #STRWHERE#
                 
                /*TagMainContractor{[  
                  And RPWR.ProjectSysNo = RPWR.ParentProjectSysNo
                ]}*/ 
               
                /*TagSpecialContractor{[  
                   And RPWR.ProjectSysNo != RPWR.ParentProjectSysNo 
                ]}*/ 
                 
               /*TagCanSeePrj{[  
                AND EXISTS
                    (
                      SELECT 1
                      FROM projectmgt.contractoruser_project T4
                      WHERE T4.ProjectSysNo = P.SysNo
                        AND T4.ContractorUserSysNo =  {0})
                ]}*/ 
                
                GROUP BY    RPWR.ProjectSysNo
                           , RPWR.ParentProjectSysNo
                           , P.ProjectName
                           , RPWR.ContractorCode
                           , RPWR.ContractorName
                           , RPWR.ContractorSysNo
              ORDER BY @SortFields) T  
              LIMIT @StartNum, @PageSize;

          ]]>
      </Text>
    </SQL>

    <!-- 查询累计工资信息 -->
    <SQL SQLKey="QueryAllProjectPayRollReport" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
            SELECT RPRR.ProjectSysNo
                 , RPRR.ParentProjectSysNo
                 , RPRR.TotalPayAmount
                 , RPRR.ActualAmount
                 , RPRR.TotalArrearsOfWages
                 , RPRR.IsPayRoll
                 , RPRR.IsArrearsOfWages
                 , RPRR.Month_Key
            FROM report.r_contractor_payroll_report RPRR
            WHERE RPRR.ProjectSysNo = @ProjectSysNo

          ]]>
      </Text>
    </SQL>


    <!-- 查询项目出勤等信息 -->
    <SQL SQLKey="QueryAllProjectWorkerReport" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
            SELECT SUM(RPWR.TOTALWORKERNUM)      AS TOTALWORKERNUM
               , SUM(RPWR.ENTRYWORKERNUM)      AS ENTRYWORKERNUM
               , SUM(RPR.SCENEWORKERNUM)       AS SCENEWORKERNUM
               , SUM(RPR.ATTENDANCETODAYNUM)   AS ATTENDANCETODAYNUM
               , SUM(RPR.SPECIALCONTRACTORNUM) AS SPECIALCONTRACTORNUM
               , SUM(RPR.SUBCONTRACTORNUM)     AS SUBCONTRACTORNUM
               , SUM(RPR.WORKERTEAMNUM)        AS WORKERTEAMNUM

          FROM report.r_project_worker_report RPWR
          INNER JOIN report.r_projectworker_report RPR
            ON RPWR.ProjectSysNo = RPR.ProjectSysNo
              AND RPWR.ContractorSysNo = RPR.ContractorSysNo

          WHERE RPWR.ParentProjectSysNo = @ProjectSysNo
            OR RPWR.ProjectSysNo = @ProjectSysNo
          ]]>
      </Text>
    </SQL>

    
    <SQL SQLKey="GetRcomprehensiveChangeReportGroupList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
            SELECT
             	`ProjectSysNo`,
	            `ProjectName`,
	            `StatRange`,
	            `StatRangeSort`,
              `ComprehensiveType`,
	            Sum(EntryWorkerNum) EntryWorkerNum,
	            Sum(TotalWorkHours) TotalWorkHours,
	            Sum(TotalManualWorkHours) TotalManualWorkHours
            FROM
            Report.r_comprehensivechange_report
            #STRWHERE#
            group by ProjectSysNo,StatRange,StatRangeSort#Group#
            order by StatRange Desc,StatRangeSort Desc
          ]]>
      </Text>
    </SQL>
    
    <!--获取刷卡率数据-->
    <SQL SQLKey="GetContractorAttendenceRates" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          SELECT
            p.SysNo ProjectSysNo,
            0 ProjectStatus,
            c.sysNo ContractorSysNo,
            c.ContractorCode,
           IFNULL(SUM(r.SystemAttendanceCount), 0) SystemAttendenceWorkerNum,
           IFNULL(SUM(r.ManualAttendanceCount), 0) ManualAttendenceWorkerNum,
           IFNULL(SUM(r.AttendanceCount), 0) AttendanceWorkerNum,
           IFNULL(SUM(r.InWorkCount), 0) InWorkerNum,
            r.CurrentDay Date
          FROM  projectmgt.projectmaster p
           LEFT JOIN projectmgt.contractormaster c
                  ON c.ContractorCode=p.ContractorCode 
            LEFT JOIN report.r_project_attendance_dailyreport r 
              ON p.SysNo = r.ProjectSysNo
                  AND r.InWorkCount > 0
                 AND r.CurrentDay >= @StartDateStr AND r.CurrentDay < @EndDateStr
          WHERE 1=1
                AND p.status=1
                AND p.projectStatus=0
                AND c.status=1
                AND p.SysNo = p.ParentProjectSysNo
            
                 AND (
                    (@Type = 0 AND
                         p.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                         )
                    or (@Type = 1 AND p.ContractorCode = @ContractorCode)
                  )
                  group by p.SysNo,r.CurrentDay
        ]]>
      </Text>
    </SQL>

    <!--获取单位列表-->
    <SQL SQLKey="GetContractorAttendenceRateList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          SELECT COUNT(1) AS TotalCount
          FROM projectmgt.contractormaster T
          WHERE T.status=1 and T.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                AND LENGTH(T.ContractorCode) <= LENGTH(@ContractorCode) + 4;
        
          SELECT
            T.SysNo          ContractorSysNo,
            T.ContractorCode ContractorCode,
            T.ContractorName ContractorName
          FROM projectmgt.contractormaster T
          WHERE T.status=1 and T.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                AND LENGTH(T.ContractorCode) <= LENGTH(@ContractorCode) + 4
          ORDER BY @SortFields LIMIT @StartNum, @PageSize;
        ]]>
      </Text>
    </SQL>
    
    <!--获取项目的承建单位刷卡率统计数据-->
    <SQL SQLKey="GetProjectAttendenceRateListForSubContractor" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
select a.SubContractorSysNo, b.SubContractorName
    , /*TagGroupByNone{['']}*/
    /*TagGroupByMonth{[date_format(a.CurrentDay, '%Y-%m')]}*/
    /*TagGroupByQuarter{[CONCAT(YEAR(a.CurrentDay),'-',quarter(a.CurrentDay))]}*/
    /*TagGroupByHalfYear{[CONCAT(YEAR(a.CurrentDay),'-', floor((month((a.CurrentDay)) - 1) / 6) + 1)]}*/
    /*TagGroupByYear{[date_format(a.CurrentDay, '%Y')]}*/
    AS CurrentDate
    , COUNT(distinct case when AttendanceCount > 0 THEN a.CurrentDay END) AttendanceDays
    , SUM(a.AttendanceCount) AttendanceCount
    , SUM(a.InWorkCount) InWorkCount
from report.v_project_attendance_dailyreport a
inner join projectmgt.subcontractorinfo b
    ON a.SubContractorSysNo = b.SysNO
where a.ProjectSysNo = @ProjectSysNo
group by a.SubContractorSysNo
    , /*TagGroupByNone{[]}*/
    /*TagGroupByMonth{[date_format(a.CurrentDay, '%Y-%m')]}*/
    /*TagGroupByQuarter{[CONCAT(YEAR(a.CurrentDay),'-',quarter(a.CurrentDay))]}*/
    /*TagGroupByHalfYear{[CONCAT(YEAR(a.CurrentDay),'-', floor((month((a.CurrentDay)) - 1) / 6))]}*/
    /*TagGroupByYear{[date_format(a.CurrentDay, '%Y')]}*/
order by a.SubContractorSysNo
    , /*TagGroupByNone{[]}*/
    /*TagGroupByMonth{[date_format(a.CurrentDay, '%Y-%m')]}*/
    /*TagGroupByQuarter{[CONCAT(YEAR(a.CurrentDay),'-',quarter(a.CurrentDay))]}*/
    /*TagGroupByHalfYear{[CONCAT(YEAR(a.CurrentDay),'-', floor((month((a.CurrentDay)) - 1) / 6))]}*/
    /*TagGroupByYear{[date_format(a.CurrentDay, '%Y')]}*/
;
        ]]>
      </Text>
    </SQL>

    <!--获取项目工种刷卡率统计数据-->
    <SQL SQLKey="GetProjectAttendenceRateListForWorkerType" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
select a.WorkTypeSysNo, b.WorkTypeName
    , /*TagGroupByNone{['']}*/
    /*TagGroupByMonth{[date_format(a.CurrentDay, '%Y-%m')]}*/
    /*TagGroupByQuarter{[CONCAT(YEAR(a.CurrentDay),'-',quarter(a.CurrentDay))]}*/
    /*TagGroupByHalfYear{[CONCAT(YEAR(a.CurrentDay),'-', floor((month((a.CurrentDay)) - 1) / 6) + 1)]}*/
    /*TagGroupByYear{[date_format(a.CurrentDay, '%Y')]}*/
    AS CurrentDate
    , COUNT(distinct case when AttendanceCount > 0 THEN a.CurrentDay END) AttendanceDays
    , SUM(a.AttendanceCount) AttendanceCount
    , SUM(a.InWorkCount) InWorkCount
from report.v_project_attendance_dailyreport a
inner join commonmgt.worktypedict b
    ON a.WorkTypeSysNo = b.SysNO
where a.ProjectSysNo = @ProjectSysNo
group by a.WorkTypeSysNo
    , /*TagGroupByNone{[]}*/
    /*TagGroupByMonth{[date_format(a.CurrentDay, '%Y-%m')]}*/
    /*TagGroupByQuarter{[CONCAT(YEAR(a.CurrentDay),'-',quarter(a.CurrentDay))]}*/
    /*TagGroupByHalfYear{[CONCAT(YEAR(a.CurrentDay),'-', floor((month((a.CurrentDay)) - 1) / 6))]}*/
    /*TagGroupByYear{[date_format(a.CurrentDay, '%Y')]}*/
order by a.WorkTypeSysNo
    , /*TagGroupByNone{[]}*/
    /*TagGroupByMonth{[date_format(a.CurrentDay, '%Y-%m')]}*/
    /*TagGroupByQuarter{[CONCAT(YEAR(a.CurrentDay),'-',quarter(a.CurrentDay))]}*/
    /*TagGroupByHalfYear{[CONCAT(YEAR(a.CurrentDay),'-', floor((month((a.CurrentDay)) - 1) / 6))]}*/
    /*TagGroupByYear{[date_format(a.CurrentDay, '%Y')]}*/
;
        ]]>
      </Text>
    </SQL>

    <!--获取项目刷卡率统计数据-->
    <SQL SQLKey="GetProjectAttendenceRateList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
          SELECT COUNT(DISTINCT T.ProjectSysNo) AS TotalCount
   FROM
            (
              SELECT
                p.sysNo ProjectSysNo,
                p.ProjectName                               ProjectName,
                c.SysNo                                    ContractorSysNo,
                c.ContractorCode                            ContractorCode,
                c.ContractorName                            ContractorName,
                IFNULL(SUM(r.InWorkCount), 0)               TotalWorkerCount,
                IFNULL(SUM(r.AttendanceCount ), 0)       AttendenceWorkerCount,
                IFNULL(SUM(r.SystemAttendanceCount), 0) SystemAttendenceWorkerCount,
                IFNULL(SUM(r.ManualAttendanceCount), 0) ManualAttendenceWorkerCount,
                COUNT(DISTINCT r.CurrentDay)                      Days
              FROM
                projectmgt.projectmaster p
                  LEFT JOIN projectmgt.contractormaster c
                   ON c.ContractorCode=p.ContractorCode  
                LEFT JOIN
                report.r_project_attendance_dailyreport r
                  ON p.SysNo = r.ProjectSysNo
                    AND r.InWorkCount > 0
                    AND r.CurrentDay >= @StartDateStr AND r.CurrentDay < @EndDateStr
              WHERE 1=1
                    AND p.status=1  AND p.SysNo = p.ParentProjectSysNo and p.projectStatus=0 and c.status=1
                    AND p.SysNo = p.ParentProjectSysNo
                    AND    
                    (
                    (@Type = 0 AND
                         p.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                          )
                    or (@Type = 1 AND p.ContractorCode = @ContractorCode)
                   )
              GROUP BY p.SysNo
            ) T;

          SELECT
            ProjectSysNo,
            ProjectName,
            ContractorSysNo,
            ContractorCode,
            ContractorName,
            TotalWorkerCount,
            SystemAttendenceWorkerCount,
            ManualAttendenceWorkerCount,
            AttendenceWorkerCount,
            Days
          FROM
            (
              SELECT
                p.sysNo ProjectSysNo,
                p.ProjectName                               ProjectName,
                c.SysNo                                    ContractorSysNo,
                c.ContractorCode                            ContractorCode,
                c.ContractorName                            ContractorName,
                IFNULL(SUM(r.InWorkCount), 0)               TotalWorkerCount,
                IFNULL(SUM(r.AttendanceCount ), 0)       AttendenceWorkerCount,
                IFNULL(SUM(r.SystemAttendanceCount), 0) SystemAttendenceWorkerCount,
                IFNULL(SUM(r.ManualAttendanceCount), 0) ManualAttendenceWorkerCount,
                COUNT(DISTINCT r.CurrentDay)                      Days
              FROM
                projectmgt.projectmaster p
                  INNER JOIN projectmgt.contractormaster c
                  ON c.ContractorCode=p.ContractorCode 
                LEFT JOIN
                report.r_project_attendance_dailyreport r
                  ON p.SysNo = r.ProjectSysNo
                    AND r.InWorkCount > 0
                    AND r.CurrentDay >= @StartDateStr AND r.CurrentDay < @EndDateStr
              WHERE 1=1
               AND p.status=1  AND p.SysNo = p.ParentProjectSysNo and p.projectStatus=0 and c.status=1
                    AND 
                   (
                    (@Type = 0 AND
                         p.ContractorCode LIKE CONCAT(@ContractorCode, '%')
                          )
                    or (@Type = 1 AND p.ContractorCode = @ContractorCode)
                   )
              GROUP BY p.SysNo
            ) T
          ORDER BY @SortFields LIMIT @StartNum, @PageSize;
        ]]>
      </Text>
    </SQL>


    <!--获取实时现场人数-->
    <SQL SQLKey="GetSenceWorkerNumFromReportByPrj" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
SELECT
	sum(t1.RealWorkingWorkerNum)
FROM
  report.projectstatreport t1
INNER JOIN projectmgt.project_subcontractor t2 ON t1.ProjectSysNo = t2.ProjectSysNo
AND t1.SubContractorSysNo = t2.SubContractorSysNo
WHERE
	t1.ProjectSysNo =@ProjectSysNo
AND t1.Date =@Date
/*TagContractorTypeFor2{[  
AND t2.ContractorType=2
                ]}*/ 
/*TagContractorTypeNotFor2{[  
AND t2.ContractorType!=2
                ]}*/ 

        ]]>
      </Text>
    </SQL>

    <!--获取实时现场人数-->
    <SQL SQLKey="GetTodayAttendanceNumFromReportByPrj" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
SELECT
	sum(t1.AttendanceWorkerNum)
FROM
	report.projectstatreport t1 
INNER JOIN projectmgt.project_subcontractor t2 ON t1.ProjectSysNo = t2.ProjectSysNo
AND t1.SubContractorSysNo = t2.SubContractorSysNo
WHERE
	t1.ProjectSysNo =@ProjectSysNo
AND t1.Date =@Date
/*TagContractorTypeFor2{[  
AND t2.ContractorType=2
                ]}*/ 
/*TagContractorTypeNotFor2{[  
AND t2.ContractorType!=2
                ]}*/ 

        ]]>
      </Text>
    </SQL>
  
<SQL SQLKey="GetPrjAttendanceRateFor7Day" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
SELECT
	(
		AttendanceWorkerNum + AttendanceWorkerNumForSubContractor
	) *100/ (
		InWorkerNum + InWorkerNumForSubContractor
	)
FROM
	report.r_projectworker_report
WHERE
	ProjectSysNo = @ProjectSysNo

        ]]>
      </Text>
    </SQL>
  
    <!--获取统计周报-->
    <SQL SQLKey="GetWeeklyReports" ConnectionKey="LaborMainRead">
      <Text>
        <![CDATA[
          SET @startDate = @beginDate;
          SET @stopDate = @endDate;
          SELECT
            id.SysNo,
            IFNULL(tr01.ProjectCount, 0)           ProjectCount,
            IFNULL(tr02.RunningProjectCount, 0)    RunningProjectCount,
            IFNULL(tr03.SubContractorCount, 0)     SubContractorCount,
            IFNULL(tr04.TeamCount, 0)              TeamCount,
            IFNULL(tr05.AppRegisterCount, 0)       AppRegisterCount,
            IFNULL(tr06.WorkerCountWithCard, 0)    WorkerCountWithCard,
            IFNULL(tr06.WorkerCountWithoutCard, 0) WorkerCountWithoutCard,
            IFNULL(tr07.CompletedPayrollCount, 0)  CompletedPayrollCount,
            IFNULL(tr07.AverageSwipeCardRate, 0)   AverageSwipeCardRate
          FROM
            (
              SELECT a.SysNo
              FROM
                (
                  SELECT (@row := @row + 1) - 1 SysNo
                  FROM projectmgt.projectmaster, (
                                                    SELECT @row := 0) row_count
                ) a
              WHERE SysNo <= IF(@getAllData > 0, 0, DATEDIFF(DATE_ADD(@stopDate, INTERVAL -1 DAY), @startDate)) DIV 7
            ) id
            LEFT JOIN
            (
              # 新增项目数
              SELECT
                IF(@getAllData > 0, 0, DATEDIFF(p.InDate, @startDate)) DIV 7 SysNo,
                COUNT(1)                                                     ProjectCount
              FROM projectmgt.projectmaster p
                INNER JOIN projectmgt.contractormaster m
                  ON p.ContractorCode = m.ContractorCode
              WHERE
                m.Status = 1 AND
                p.Status = 1 AND
                p.SysNo = p.ParentProjectSysNo AND
                p.ContractorCode LIKE CONCAT(@contractorCode, '%') AND
                p.InDate >= @startDate AND
                p.InDate < @stopDate
              GROUP BY IF(@getAllData > 0, 0, DATEDIFF(p.InDate, @startDate)) DIV 7
            ) tr01
              ON id.SysNo = tr01.SysNo
            LEFT JOIN
            (
              # 新增运行项目数
              SELECT
                b.SysNo         SysNo,
                COUNT(DISTINCT
                      IF(b.ValidAttendanceCountDays > 0 && b.ValidInWorkCountDays > 0, b.ProjectSysNo,
                          NULL)) RunningProjectCount
              FROM
                (
                  # 某个项目在某周 有出勤人数的天数，有合法在场人数天数
                  SELECT
                    IF(@getAllData > 0, 0, DATEDIFF(a.CurrentDay, @startDate)) DIV 7 SysNo,
                    a.ProjectSysNo                                                   ProjectSysNo,
                    SUM(IF(a.AttendanceCount > 0 AND a.InWorkCount > 0, 1, 0))       ValidAttendanceCountDays,
                    SUM(IF(a.InWorkCount >= @validInWorkerCount, 1, 0))              ValidInWorkCountDays
                  FROM
                    (
                      # 某个项目在某天的 考勤人数/在场人数
                      SELECT
                        r.CurrentDay           CurrentDay,
                        r.ProjectSysNo         ProjectSysNo,
                        SUM(r.AttendanceCount) AttendanceCount,
                        SUM(r.InWorkCount)     InWorkCount
                      FROM report.r_project_attendance_dailyreport r
                      WHERE r.CurrentDay >= @startDate AND
                            r.CurrentDay < @stopDate
                      GROUP BY r.CurrentDay, r.ProjectSysNo
                    ) a
                    INNER JOIN projectmgt.projectmaster p
                      ON p.SysNo = a.ProjectSysNo
                    INNER JOIN projectmgt.contractormaster m
                      ON p.ContractorCode = m.ContractorCode
                  WHERE
                    m.Status = 1 AND
                    p.Status = 1 AND
                    p.SysNo = p.ParentProjectSysNo AND
                    p.ContractorCode LIKE CONCAT(@contractorCode, '%') AND
                    p.InDate >= @startDate AND
                    p.InDate < @stopDate AND
                    (IF(@getAllData > 0, 0, DATEDIFF(a.CurrentDay, @startDate)) DIV 7) =
                    (IF(@getAllData > 0, 0, DATEDIFF(p.InDate, @startDate)) DIV 7)
                  GROUP BY IF(@getAllData > 0, 0, DATEDIFF(a.CurrentDay, @startDate)) DIV 7, a.ProjectSysNo
                ) b
              GROUP BY b.SysNo
            ) tr02
              ON id.SysNo = tr02.SysNo
            LEFT JOIN
            (
              # 新增参建单位数
              SELECT
                IF(@getAllData > 0, 0, DATEDIFF(cs.InDate, @startDate)) DIV 7 SysNo,
                COUNT(DISTINCT s.SysNo)                                       SubContractorCount
              FROM projectmgt.subcontractorinfo s
                INNER JOIN projectmgt.contractor_subcontractor cs
                  ON s.SysNo = cs.SubContractorSysNo
                INNER JOIN projectmgt.contractormaster cm
                  ON cs.ContractorSysNo = cm.SysNo
              WHERE s.Status = 1 AND
                    cm.Status = 1 AND
                    cm.ContractorCode LIKE CONCAT(@contractorCode, '%') AND
                    cs.InDate >= @startDate AND
                    cs.InDate < @stopDate
              GROUP BY IF(@getAllData > 0, 0, DATEDIFF(cs.InDate, @startDate)) DIV 7
            ) tr03
              ON id.SysNo = tr03.SysNo
            LEFT JOIN
            (
              # 新增班组数
              SELECT
                IF(@getAllData > 0, 0, DATEDIFF(t.InDate, @startDate)) DIV 7 SysNo,
                COUNT(1)                                                     TeamCount
              FROM projectmgt.teammaster t
                INNER JOIN projectmgt.projectmaster p
                  ON t.ProjectSysNo = p.SysNo
                INNER JOIN projectmgt.contractormaster m
                  ON p.ParentContractorCode = m.ContractorCode
              WHERE t.Status = 1 AND
                    m.Status = 1 AND
                    p.Status = 1 AND
                    p.ParentContractorCode LIKE CONCAT(@contractorCode, '%') AND
                    t.InDate >= @startDate AND
                    t.InDate < @stopDate
              GROUP BY IF(@getAllData > 0, 0, DATEDIFF(t.InDate, @startDate)) DIV 7
            ) tr04
              ON id.SysNo = tr04.SysNo
            LEFT JOIN
            (
              # 新增APP注册数
              SELECT
                IF(@getAllData > 0, 0, DATEDIFF(w.InDate, @startDate)) DIV 7 SysNo,
                COUNT(1)                                                     AppRegisterCount
              FROM workermgt.workeruser w
              WHERE
                w.InDate >= @startDate AND
                w.InDate < @stopDate
              GROUP BY IF(@getAllData > 0, 0, DATEDIFF(w.InDate, @startDate)) DIV 7
            ) tr05
              ON id.SysNo = tr05.SysNo
            LEFT JOIN
            (
              # 新增建筑工人：制卡/系统导入
              SELECT
                IF(@getAllData > 0, 0, DATEDIFF(w.InDate, @startDate)) DIV 7 SysNo,
                SUM(IF(w.InUserName = 'Importer', 1, 0))                     WorkerCountWithoutCard,
                SUM(IF(w.InUserName = 'Importer', 0, 1))                     WorkerCountWithCard
              FROM workermgt.workermaster w
              WHERE w.Status = 1 AND
                    w.InDate >= @startDate AND
                    w.InDate < @stopDate
              GROUP BY IF(@getAllData > 0, 0, DATEDIFF(w.InDate, @startDate)) DIV 7
            ) tr06
              ON id.SysNo = tr06.SysNo
            LEFT JOIN
            (
              # 新增‘已完成发放’工资单数量，以及刷卡率
              SELECT
                IF(@getAllData > 0, 0, DATEDIFF(r.CurrentDay, @startDate)) DIV 7                 SysNo,
                IFNULL(SUM(IF(r.InWorkCount > 0, r.AttendanceCount, 0)) / SUM(r.InWorkCount), 0) AverageSwipeCardRate,
                SUM(r.PayNum)                                                                    CompletedPayrollCount
              FROM report.r_project_attendance_dailyreport r
                INNER JOIN projectmgt.projectmaster p
                  ON p.SysNo = r.ProjectSysNo
                INNER JOIN projectmgt.contractormaster m
                  ON p.ContractorCode = m.ContractorCode
              WHERE m.Status = 1 AND
                    p.Status = 1 AND
                    p.SysNo = p.ParentProjectSysNo AND
                    p.ContractorCode LIKE CONCAT(@contractorCode, '%') AND
                    r.CurrentDay >= @startDate AND
                    r.CurrentDay < @stopDate
              GROUP BY IF(@getAllData > 0, 0, DATEDIFF(r.CurrentDay, @startDate)) DIV 7
            ) tr07
              ON id.SysNo = tr07.SysNo;
        ]]>
      </Text>
    </SQL>

    <!--获取项目刷卡率排行（月报）-->
<SQL SQLKey="QueryPrjAttdenceRank" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
SELECT
	SUM(t1.InWorkCount) InWorkCount,
	sum(t1.AttendanceCount) AttendanceCount,
  sum(t1.AttendanceCount)*100/SUM(t1.InWorkCount) AttendanceRate,
	t1.ProjectSysNo,
  t3.ProjectName,
  t3.ContractorCode,
  t4.ContractorName
FROM
	report.r_project_attendance_dailyreport t1
INNER JOIN projectmgt.projectmaster t3 on t1.ProjectSysNo=t3.SysNo
INNER JOIN projectmgt.contractormaster t4 on t3.ContractorCode=t4.ContractorCode
WHERE
	 t1.ContractorCode LIKE CONCAT(@ContractorCode,'%')
   and t1.CurrentDay<=@EndDate
GROUP BY 
	t1.ProjectSysNo
order by AttendanceRate desc
limit 10
        ]]>
      </Text>
    </SQL>
    
    <!--月报机构汇总统计-->
    <SQL SQLKey="GetContractorMonthStatisticByYear" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
#set @contractorCodelike = '00010100%';  
#set @year=year('2017-06-01');

drop temporary table  if EXISTS report.TempYearMonth ;
create temporary table report.TempYearMonth (yearMonth varchar(10)); 
insert into report.TempYearMonth values 
#TagYearMonth#

#————————————————————————当前组织机构下x年x月新增的党建活动数————————————————————————
drop temporary table  if EXISTS report.TempPartyActivity;
create temporary table report.TempPartyActivity  (
SELECT 
	DATE_FORMAT(ActivityStartDate, '%Y-%m') as yearMonth ,
	sum(1) as TotalPartyActivity
FROM workermgt.partyactivity a
INNER JOIN projectmgt.projectmaster b ON b.sysno = a.projectsysno
INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = b.ContractorCode
WHERE ActivityStatus = 1 AND b.status = 1 AND cm.status = 1
        AND ActivityStartDate < now()
        AND b.ContractorCode LIKE @contractorCodelike
       group by  DATE_FORMAT(ActivityStartDate, '%Y-%m')
);

#————————————————————————当前组织机构下x年x月新增的工人数————————————————————————
drop temporary table  if EXISTS report.TempWorkerYearMonth;
create temporary table report.TempWorkerYearMonth  (
SELECT 
        DATE_FORMAT(b.indate, '%Y-%m') AS YearMonth,
        COUNT(DISTINCT a.WorkerSysNo) TotalWorker
        FROM projectmgt.contractor_worker a
        INNER JOIN workermgt.workermaster b ON a.WorkerSysNo = b.sysno
        INNER JOIN projectmgt.contractormaster r ON a.ContractorSysNo = r.SysNo
        WHERE a.Status = 1 AND b.Status = 1 AND r.Status = 1
                AND (r.ContractorCode LIKE @contractorCodelike)
        GROUP BY DATE_FORMAT(b.indate, '%Y-%m')
);

#————————————————————————当前组织机构下x年x月新增的党员认证数——————————————————————————————
drop temporary table if EXISTS report.TempWorkerpartyauthrecord;
create temporary table report.TempWorkerpartyauthrecord  (
SELECT
	DATE_FORMAT(AuthConfirmDate, '%Y-%m') as yearMonth, #a.InDate
	sum(1) as TotalWorkerPartyAuthed
FROM workermgt.workerpartyauthrecord  a
INNER JOIN projectmgt.projectmaster b ON b.sysno = a.projectsysno
INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = b.ContractorCode
WHERE CommunistAuthStatus = 1  AND b.status = 1 AND cm.status = 1
      AND b.ContractorCode LIKE @contractorCodelike
       group by  DATE_FORMAT(AuthConfirmDate, '%Y-%m') #a.InDate
 );
 
#————————————————————————当前组织机构下x年x月新增APP用户数——————————————————————————————
drop temporary table if EXISTS report.TempAPPUser;
create temporary table report.TempAPPUser  (
SELECT
	DATE_FORMAT(InDate, '%Y-%m') as yearMonth, 
	sum(1) as TotalAppUser
FROM workermgt.workeruser 
WHERE status = 1
group by  DATE_FORMAT(InDate, '%Y-%m')
);
 
#————————————————————————当前组织机构下x年x月Daily表中有考勤的项目——————————————————————————————
drop temporary table  if EXISTS report.TempDailyAttendance1;
create temporary table report.TempDailyAttendance1 (
SELECT ProjectSysNo,ad.ContractorCode,CurrentDay,
       SUM(InWorkCount) AS InWorkCount ,SUM(AttendanceCount) AS AttendanceCount
FROM   report.r_project_attendance_dailyreport ad
WHERE  YEAR(CurrentDay) = @year AND ad.ContractorCode LIKE @contractorCodelike
        AND ad.ProjectSysNo = ad.ParentProjectSysNo 
        AND YEAR(CurrentDay) = @year 
        AND ProjectSysNo IN ( SELECT DISTINCT sysNo FROM projectmgt.projectmaster B WHERE B.STATUS=1)
        AND ContractorCode IN ( SELECT DISTINCT ContractorCode FROM projectmgt.contractormaster C WHERE C.status=1)
        AND (InWorkCount>0 Or AttendanceCount>0)
GROUP BY ProjectSysNo,ContractorCode,CurrentDay
);

DROP temporary TABLE IF EXISTS report.TempDailyAttendance2;
create temporary table report.TempDailyAttendance2
SELECT distinct ProjectSysNo, date_format(CurrentDay,'%Y-%m') AS YEARMONTH
FROM report.TempDailyAttendance1
WHERE AttendanceCount>0;

DROP temporary TABLE IF EXISTS report.TempDailyAttendance3;
create temporary table report.TempDailyAttendance3
SELECT distinct ProjectSysNo, date_format(CurrentDay,'%Y-%m') AS YEARMONTH
FROM report.TempDailyAttendance1
WHERE InWorkCount>=10;
 
SELECT 
    t.*,
    t1.TotalProject,
    t2.SKRatio,
    t3.TotalPayRollCount,
    t3.TotalPayAmount,
    (SELECT SUM(TotalAppUser) FROM report.TempAPPUser b WHERE b.yearMonth<=t.yearmonth) AS TotalAppUser,
    (SELECT SUM(TotalPartyActivity) from report.TempPartyActivity b WHERE b.yearMonth<=t.yearmonth) AS TotalPartyActivity,
    (SELECT SUM(TotalWorker) from report.TempWorkerYearMonth b WHERE b.yearMonth<=t.yearmonth) AS TotalWorker,   
    (SELECT SUM(TotalWorkerPartyAuthed) from report.TempWorkerpartyauthrecord b WHERE b.yearMonth<=t.yearmonth) AS TotalWorkerPartyAuthed
FROM
    report.TempYearMonth t
    
LEFT JOIN #当前组织机构下x年x月运行的项目数#
(
  SELECT A.YearMonth, COUNT(DISTINCT A.ProjectSysNo) AS TotalProject
  FROM report.TempDailyAttendance2 A
  JOIN report.TempDailyAttendance3  B
  ON A.ProjectSysNo=B.ProjectSysNo AND A.YearMonth=B.YearMonth
  GROUP BY A.YearMonth
) t1 ON t.YearMonth = t1.YearMonth

LEFT JOIN #当前组织机构下x年x月平均刷卡率#
    (SELECT 
        DATE_FORMAT(CurrentDay, '%Y-%m') AS YearMonth,
	    SUM(AttendanceCount) / SUM(InWorkCount) AS SKRatio
    FROM
        report.r_project_attendance_dailyreport ad
    INNER JOIN projectmgt.projectmaster pr ON pr.sysno = ad.ProjectSysNo
    INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = pr.ContractorCode
    WHERE pr.status = 1 AND cm.status = 1 
            AND ad.ContractorCode LIKE @contractorCodelike
           # AND ad.ProjectSysNo = ad.ParentProjectSysNo
            AND YEAR(CurrentDay) = @year
    GROUP BY DATE_FORMAT(CurrentDay, '%Y-%m')
) t2 ON t.yearMonth = t2.YearMonth

LEFT JOIN #当前组织机构下工资发放笔数和金额#
    (      
    SELECT 
        Month_Key AS YearMonth,
        SUM(ActualAmount_Bank+ActualAmount_Cash) AS TotalPayAmount,
        SUM(ActualNum_Bank+ActualNum_Cash) AS TotalPayRollCount
    FROM
        report.r_contractor_payroll_report  p
    INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = p.ContractorCode
    WHERE cm.status = 1 AND 
        Year_Key = @year AND p.ContractorCode LIKE @contractorCodelike
    GROUP BY Month_Key
) t3 ON t.yearMonth = t3.YearMonth
        ]]>
      </Text>
    </SQL>
    
    <!--月报子级机构所有统计-->
    <SQL SQLKey="GetChildContractorStatisticByYearMonth" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
#set @contractorCode = '00010100____'; 
#set @contractorCodelike = '00010100____%'; 
#set @contractorCodeLength = LENGTH(@contractorCode);
#set @dtBegin='2017-06-01';
#set @dtEnd='2017-07-01';

drop temporary table  if EXISTS report.STempDailyAttendance1;
create temporary table report.STempDailyAttendance1 (
SELECT distinct( ProjectSysNo),ad.ContractorCode, 
       CurrentDay,SUM(AttendanceCount) AS AttendanceCount
FROM  report.r_project_attendance_dailyreport ad
INNER JOIN projectmgt.projectmaster pr ON pr.sysno = ad.ProjectSysNo
INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = ad.ContractorCode
WHERE pr.status = 1 AND cm.status = 1
    AND pr.InDate < @dtEnd
    AND ad.ContractorCode LIKE @contractorCodelike
    AND ad.ProjectSysNo = ad.ParentProjectSysNo
    AND currentday >= @dtBegin
    AND currentday < @dtEnd
    AND AttendanceCount>0 
GROUP BY projectsysno , CurrentDay); 

drop temporary table  if EXISTS report.STempDailyAttendance2;
create temporary table report.STempDailyAttendance2  (
SELECT  ProjectSysNo, CurrentDay, SUM(InWorkCount) AS InWorkCount
FROM report.r_project_attendance_dailyreport ad
INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = ad.ContractorCode
INNER JOIN projectmgt.projectmaster pr ON pr.sysno = ad.ProjectSysNo
WHERE pr.status = 1 AND cm.status = 1
     AND pr.InDate < @dtEnd
                AND ad.ContractorCode LIKE @contractorCodelike
                AND ad.ProjectSysNo = ad.ParentProjectSysNo
                AND currentday >= @dtBegin
                AND currentday < @dtEnd
        And InWorkCount > 0
GROUP BY projectsysno , CurrentDay);

drop temporary table  if EXISTS report.STempDailyAttendance3;
create temporary table report.STempDailyAttendance3 (
SELECT  distinct( ProjectSysNo), ad.ContractorCode, CurrentDay,
        SUM(AttendanceCount) AS AttendanceCount
FROM  report.r_project_attendance_dailyreport ad
INNER JOIN projectmgt.projectmaster pr ON pr.sysno = ad.ProjectSysNo
INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = ad.ContractorCode
WHERE pr.status = 1 AND cm.status = 1 
      AND pr.InDate >= @dtBegin AND pr.InDate < @dtEnd
      AND ad.ContractorCode LIKE @contractorCodelike
      AND ad.ProjectSysNo = ad.ParentProjectSysNo
      AND currentday >= @dtBegin
      AND currentday < @dtEnd 
      AND AttendanceCount>0 
GROUP BY projectsysno , CurrentDay); 

drop temporary table  if EXISTS report.STempDailyAttendance4;
create temporary table report.STempDailyAttendance4  (
SELECT  ProjectSysNo, CurrentDay,  SUM(InWorkCount) AS InWorkCount
FROM report.r_project_attendance_dailyreport ad
INNER JOIN  projectmgt.contractormaster cm ON cm.ContractorCode = ad.ContractorCode
INNER JOIN  projectmgt.projectmaster pr ON pr.sysno = ad.ProjectSysNo
WHERE pr.status = 1 AND cm.status = 1
      AND pr.InDate >= @dtBegin AND pr.InDate < @dtEnd
      AND ad.ContractorCode LIKE @contractorCodelike
      AND ad.ProjectSysNo = ad.ParentProjectSysNo
      AND currentday >= @dtBegin
      AND currentday < @dtEnd
      AND InWorkCount > 0
GROUP BY projectsysno , CurrentDay );

 
SELECT 
    t.*, t1.TotalPartyMember,t2.AuthedPartyMember,t3.ActivityCount,
    t4.TotalProjectCount,t5.NewProjectCount,t6.SKRatio,
    t7.TotalShouldPayAmount,
    t7.TotalActualPayAmount,
    t7.TotalUnPayAmount,
    t7.TotalUnFullPayProject,
    t7.OnLinePayCount,#银行代发完毕的笔数
    t7.OffLinePayCount#现金发放完毕的笔数 
FROM
    (SELECT 
        sysno, ContractorCode, ContractorName
    FROM
        projectmgt.contractormaster
    WHERE
        ContractorCode LIKE @contractorCode
            AND status = 1
    ORDER BY sysno , ContractorCode) 
AS t
        
LEFT JOIN #子级机构截止当月全部党员数量#
    (SELECT 
        SUM(1) AS TotalPartyMember,
            LEFT(c.ContractorCode,@contractorCodeLength) AS ContractorCode
    FROM
        projectmgt.contractor_worker a
    INNER JOIN workermgt.workermaster b ON a.workersysno = b.sysno
    INNER JOIN projectmgt.contractormaster c ON a.ContractorSysNo = c.sysno
    WHERE
        a.Status = 1 AND c.status = 1 AND b.InDate < @dtEnd
            AND b.PoliticsType IN (0 , 1)
            AND c.ContractorCode LIKE @contractorCodelike
    GROUP BY LEFT(c.ContractorCode,@contractorCodeLength)
    )t1 ON t1.contractorcode = t.contractorcode
   
LEFT JOIN #子级机构截止当月已认证党员数#
    ( SELECT 
        LEFT(b.ContractorCode, @contractorCodeLength) AS ContractorCode,
            SUM(1) AS AuthedPartyMember
    FROM
        workermgt.workerpartyauthrecord a
    INNER JOIN projectmgt.projectmaster b ON b.sysno = a.projectsysno
    INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = b.ContractorCode
    WHERE
        a.InDate < @dtEnd AND cm.status = 1
            AND a.CommunistAuthStatus = 1
            AND b.ContractorCode LIKE @contractorCodelike
            AND b.status = 1
    GROUP BY LEFT(b.ContractorCode, @contractorCodeLength) 
    )t2 ON t2.contractorcode = t.contractorcode

LEFT JOIN #子级机构截止当月党建活动数#
    ( SELECT 
        LEFT(b.ContractorCode, @contractorCodeLength) AS ContractorCode,
            SUM(1) AS ActivityCount
    FROM
        workermgt.partyactivity a
    INNER JOIN projectmgt.projectmaster b ON b.sysno = a.projectsysno
    INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = b.ContractorCode
    WHERE
        ActivityStatus = 1 AND cm.status = 1
            AND ActivityStartDate < @dtEnd
            AND b.ContractorCode LIKE @contractorCodelike
            AND b.status = 1
    GROUP BY LEFT(b.ContractorCode, @contractorCodeLength) 
    )t3 ON t3.contractorcode = t.contractorcode
    
LEFT JOIN #子级机构截止当月累计项目数#
    (
        SELECT 
           COUNT(DISTINCT (ProjectSysNo)) AS TotalProjectCount,
           LEFT(ContractorCode, @contractorCodeLength) AS ContractorCode
           FROM(
        		select * from report.STempDailyAttendance1 r1
        		where (select max(InWorkCount) from report.STempDailyAttendance2 r2 
        				    where DATE_FORMAT(r1.CurrentDay, '%Y-%m') = DATE_FORMAT(r2.CurrentDay, '%Y-%m') 
        		        and r1.projectsysno = r2.projectsysno
                  )>=10
        ) temp   
        GROUP BY LEFT(ContractorCode, @contractorCodeLength)
    )t4 ON t4.contractorcode = t.contractorcode
    
LEFT JOIN #子级机构当月新增项目数#
    (
        SELECT 
           COUNT(DISTINCT (ProjectSysNo)) AS NewProjectCount,
           LEFT(ContractorCode, @contractorCodeLength) AS ContractorCode
           FROM (
        		select * from report.STempDailyAttendance3 r1
        		where (select max(InWorkCount) from report.STempDailyAttendance4 r2 
        			      where DATE_FORMAT(r1.CurrentDay, '%Y-%m') = DATE_FORMAT(r2.CurrentDay, '%Y-%m') 
        		        and r1.projectsysno = r2.projectsysno
                   )>=10
        )temp   
        GROUP BY LEFT(ContractorCode, @contractorCodeLength)
    )t5 ON t5.contractorcode = t.contractorcode
    
LEFT JOIN #子级机构当月平均刷卡率#
(
SELECT  
	   SUM(AttendanceCount) / SUM(InWorkCount) AS SKRatio,
	   LEFT(ad.ContractorCode, @contractorCodeLength) AS ContractorCode
    FROM report.r_project_attendance_dailyreport ad
	  INNER JOIN projectmgt.projectmaster pr ON pr.sysno = ad.ProjectSysNo
    INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = pr.ContractorCode
    WHERE currentday >= @dtBegin  AND cm.status = 1
            AND currentday < @dtEnd
            AND ad.ContractorCode LIKE @contractorCodelike
            AND pr.status = 1  
		GROUP BY LEFT(ad.ContractorCode, @contractorCodeLength)
)t6 ON t6.contractorcode = t.contractorcode

LEFT JOIN #
(
SELECT 
    SUM(TotalPayAmount) AS TotalShouldPayAmount,
    SUM(ActualAmount_Bank+ActualAmount_Cash) AS   TotalActualPayAmount,
    SUM(TotalArrearsOfWages) AS TotalUnPayAmount,
    count(distinct(Case when IsArrearsOfWages = 1 Then projectSysNo End)) AS TotalUnFullPayProject,
    SUM(ActualNum_Bank) AS OnLinePayCount,#银行代发完毕的笔数
    SUM(ActualNum_Cash) AS OffLinePayCount,#现金发放完毕的笔数
    LEFT(p.ContractorCode, @contractorCodeLength) AS ContractorCode
FROM
    report.r_contractor_payroll_report p
INNER JOIN projectmgt.contractormaster cm ON cm.ContractorCode = p.ContractorCode
WHERE Month_Key =  date_format(@dtBegin,'%Y-%m')  AND cm.status = 1
        AND p.ContractorCode LIKE @contractorCodelike
GROUP BY LEFT(p.ContractorCode, @contractorCodeLength)
)t7 ON t7.contractorcode = t.contractorcode
        ]]>
      </Text>
    </SQL>

    <!--月报分包商合作项目数或在场分包在场人数排行-->
    <SQL SQLKey="GetMonthReportSubContractorProjectRankList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[            
            SELECT 
              a.SysNo SubContractorSysNo, 
              a.SubContractorName, 
              b.ProjectTotal
            FROM ProjectMgt.SubContractorInfo a
            INNER JOIN
            ( 
                SELECT M.SubContractorSysNo, COUNT(DISTINCT M.ParentProjectSysNo) ProjectTotal
                FROM
                (
                    SELECT aa.SubContractorSysNo, bb.ParentProjectSysNo FROM ProjectMgt.Project_SubContractor aa
                    INNER JOIN ProjectMgt.ProjectMaster bb
                        ON aa.ProjectSysNo = bb.SysNo 
                    #STRWHERE#
                    /*TagWhereMan{[ And bb.ContractorCode LIKE '{0}%' ]}*/  
                    AND aa.SubContractorSysNo NOT IN (1)
                    UNION ALL
                    SELECT aa.SubContractorSysNo, bb.ParentProjectSysNo FROM ProjectMgt.Project_SubContractor aa
                    INNER JOIN ProjectMgt.ProjectMaster bb
                        ON aa.ProjectSysNo = bb.SysNo 
                    INNER JOIN ProjectMgt.ProjectMaster ee
                        ON bb.ParentProjectSysNo = ee.SysNo
                   #STRWHERE#
                   /*TagWhereChild{[ And ee.ContractorCode LIKE '{0}%' ]}*/  
                   AND aa.SubContractorSysNo NOT IN (1)
                ) M
                GROUP BY M.SubContractorSysNo
                HAVING COUNT(DISTINCT M.ParentProjectSysNo) > 0
                ORDER BY COUNT(DISTINCT M.ParentProjectSysNo) DESC
                limit #ShowTopCount#    
            ) b
            ON a.SysNo = b.SubContractorSysNo
        ]]>
      </Text>
    </SQL>
    
    <!--月报分包商分包在场人数与工资发放总额排行-->
    <SQL SQLKey="GetMonthReportSubContractorInWorkOrCompletedPayrollAmountRankList" ConnectionKey="ReportRead">
      <Text>
         <![CDATA[
            select
	            ts.SubContractorSysNo,
	            projectmgt.subcontractorinfo.SubContractorName,
	            ts.InWorkCount,
	            ts.CompletedPayrollAmount
            from
            (
            SELECT
            report.r_project_attendance_dailyreport.SubContractorSysNo,
            sum(InWorkCount) InWorkCount,
           sum(
             case 
              when report.r_project_attendance_dailyreport.CurrentDay<@CurrentDay then 0
              else
		          IFNULL(
			          report.r_project_attendance_dailyreport.TotalAmount,
			          0
		          ) end
	        ) CompletedPayrollAmount
            FROM
            report.r_project_attendance_dailyreport
            Inner Join projectmgt.contractormaster on projectmgt.contractormaster.ContractorCode=report.r_project_attendance_dailyreport.ContractorCode and  projectmgt.contractormaster.`Status` = 1
            #STRWHERE#
            AND  report.r_project_attendance_dailyreport.SubContractorSysNo NOT IN (1)
            and report.r_project_attendance_dailyreport.ProjectSysNo=report.r_project_attendance_dailyreport.ParentProjectSysNo
            group by report.r_project_attendance_dailyreport.SubContractorSysNo
            order by #SortFiled# desc  ) ts
            INNER join projectmgt.subcontractorinfo on projectmgt.subcontractorinfo.SysNo=ts.SubContractorSysNo
            limit #ShowTopCount#    
        ]]>
      </Text>
    </SQL>

    <!--月报分包商在册人数排行-->
    <SQL SQLKey="GetMonthReportSubContractorRegisteredWorkRankList" ConnectionKey="ReportRead">
      <Text>
        <![CDATA[
        SELECT
	        ts.SubContractorSysNo,
	        projectmgt.subcontractorinfo.SubContractorName,
	        ts.RegisteredWorkCount
        FROM
	        (
		        SELECT
			        projectmgt.subcontractor_worker.SubContractorSysNo,
			        COUNT(
				        DISTINCT projectmgt.subcontractor_worker.WorkerSysNo
			        ) RegisteredWorkCount
		        FROM
			        projectmgt.subcontractor_worker
		        INNER JOIN projectmgt.contractor_subcontractor ON projectmgt.contractor_subcontractor.SubContractorSysNo = projectmgt.subcontractor_worker.SubContractorSysNo
            Inner Join projectmgt.contractormaster on projectmgt.contractormaster.SysNo=projectmgt.contractor_subcontractor.ContractorSysNo and  projectmgt.contractormaster.`Status` = 1
		        INNER JOIN workermgt.workermaster ON workermgt.workermaster.SysNo = projectmgt.subcontractor_worker.WorkerSysNo
		        #STRWHERE#
			      AND projectmgt.subcontractor_worker.`Status` = 1
		        AND workermgt.workermaster.`Status` = 1
            AND  projectmgt.contractor_subcontractor.SubContractorSysNo NOT IN (1)
		        GROUP BY
			        projectmgt.subcontractor_worker.SubContractorSysNo
		        ORDER BY
			        RegisteredWorkCount DESC

	        ) ts
        INNER JOIN projectmgt.subcontractorinfo ON projectmgt.subcontractorinfo.SysNo = ts.SubContractorSysNo
        limit #ShowTopCount#  
        ]]>
      </Text>
    </SQL>
  </SQLList>
</SQLConfig>